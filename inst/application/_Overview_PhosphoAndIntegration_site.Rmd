---
title: "Integration of PTM Features and Total Proteome Data for Comprehensive Phosphoproteomics Analysis"
author: "Functional Genomics Center Zurich"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    toc: true
  bookdown::html_document2:
    toc: true
  pdf_document: 
    toc: true
header-includes: 
  \usepackage{fancyhdr}
  \pagestyle{fancy}
  \fancyhead[CO,CE]{PTM Features and Total Proteome Integration Analysis}
  \fancyfoot[CO,CE]{\textbf{FGCZ} - www.fgcz.ch - 2018}
  \fancyfoot[LE,RO]{\thepage} 
params:
  data: NULL
  grp: NULL
vignette: >
  %\VignetteIndexEntry{FGCZ Two-Group Analysis}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
bibliography: bibliography2025.bib
editor_options: 
  chunk_output_type: console
always_allow_html: true
---



```{r setup, include=FALSE}

knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE
)

grp2 <- params$grp
data_diff_diff <- params$data
```

# Overview

This report will be stored at a later point in the LIMS system [_bfabric_](https://fgcz-bfabric.uzh.ch) [@Trker2010] in the 
__project__: `r grp2$Bfabric$projectID`, __order__: `r grp2$project_spec$orderID`, `r if(!is.null(grp2$project_spec$workunitID)){ "with the workunit ID :" }`  `r grp2$project_spec$workunitID`. Currently it is only uploaded as generic zip resource and attached to the result of the order.

In this analysis, both enriched (phosphopeptide enrichment) and non-enriched (total proteome) samples are analyzed separately using standard proteomics software. For the total proteome analysis, protein quantification is performed by aggregating peptide-level measurements to protein-level abundances. For the phosphoproteome analysis, phosphorylation site-specific quantification is performed using PTM-centric workflows. Both datasets are statistically evaluated individually to generate separate reports for differential protein expression (DPE) and differential PTM expression.

After individual analysis, the two datasets are integrated to perform differential PTM usage (DPU) analysis. For all phosphorylation sites where the corresponding protein is also quantified in the total proteome measurement, the protein-level statistics are used to normalize the observed changes in phosphorylation site abundance. This normalization follows the approach described for MSstatsPTM [@Kohler2023yo], where the difference in phosphorylation site levels between conditions is adjusted by the difference in total protein levels for the same comparison. This integrated analysis reveals whether changes in phosphorylation are due to changes in protein abundance or to changes in site-specific modification usage, providing deeper insights into cellular signaling and regulation.

# Numbers

```{r nummms, eval=TRUE, fig.height=5, fig.width=8}
# pick your contrast and subset as before
coi         <- unique(data_diff_diff$contrast)[1]
data_diff_1C <- subset(data_diff_diff, contrast == coi)
tbl_modAA <- table(data_diff_1C$modAA, useNA = "no")

n_sites <- length(unique(data_diff_1C$site))

tbl_combined <- c(tbl_modAA, Total = n_sites)

df_summary <- tibble::enframe(tbl_combined, name = "Modification", value = "Count")
knitr::kable(df_summary, 
             caption = paste0("Overview on identified phospho sites"))

```


# Joining Phosphorylation Sites with Total Proteome

```{r foundInGlobal, eval=TRUE}
tt <- data_diff_diff |>
  dplyr::select(protein_Id, measured_In) |>
  dplyr::distinct() |>
  dplyr::pull(measured_In) |>
  table()

# Calculate percentages
percFoundInGlobal <- tt["both"] / (tt["both"] + tt["site"]) * 100
totProtFromSites <- (tt["both"] + tt["site"])
sitesM <- data_diff_diff |>  
  dplyr::select(protein_Id, site, measured_In) |> 
  dplyr::distinct() |> 
  dplyr::pull(measured_In) |> 
  table()
```

When phosphopeptide enrichment is performed, some peptides are identified for which there is no corresponding protein identification in the total proteome measurement. Therefore, protein-level information may be missing for some phosphorylation sites. Here, for `r percFoundInGlobal`% of all identified phosphoproteins (`r totProtFromSites` total), the corresponding protein is also quantified in the total proteome measurements. For `r sitesM["both"]` phosphorylation sites mapping to a total of `r tt["both"]` proteins, we can perform integrated analysis combining both datasets.


# Integration with Total Proteome

Next, we integrate the phosphorylation site statistics with the protein-level changes using the MSstatsPTM approach [@Kohler2023yo]. We refer to this as *MSstatsPTM adjustment* and refer to these statistics in our outputs as *diff_diff* and *FDR_I*. This analysis reveals differential PTM usage (DPU), which distinguishes between changes due to protein abundance and changes due to site-specific modification usage.

In brief, the difference in phosphorylation site levels between two conditions is normalized by the difference in total protein levels for the same contrast. By doing so, protein-level changes are subtracted from phosphorylation site changes, and the adjusted statistics are used to calculate raw and adjusted p-values (FDR_I) for the normalized difference (diff_diff). This approach reveals whether phosphorylation changes are due to changes in protein abundance or to changes in site-specific modification usage.


```{r tableAllProt}
bb <- data_diff_diff |>
  dplyr::select(all_of(c("site", "site", "protein_Id", "contrast", 
                         "modelName.site", "modAA", "diff_diff", "FDR_I")))
bb <- crosstalk::SharedData$new(bb, ~site, group = "BB")

DT::datatable(bb, filter = "bottom",
  extensions = "Scroller",
  style = "auto",
  class = "compact",
  options = list(deferRender = TRUE,
                 scrollY = 300,
                 scrollX = 400,
                 scroller = TRUE)) |>
  DT::formatRound(
    columns = c('diff_diff', 'FDR_I'), 
    digits = 3,
    caption = "Differential PTM usage analysis results of all phospho sites (showing MSstatsPTM adjusted log2FCs and FDR)"
  )

```


(ref:scatterplot) Phosphorylation site differences (Y axis) as a function of protein differences (X axis). This scatter plot shows the relationship between changes in total protein abundance and changes in phosphorylation site abundance, helping to identify whether phosphorylation changes are driven by protein-level changes or by site-specific modification usage.

```{r scatterplot, fig.cap="(ref:scatterplot)", fig.width=9, fig.height=7, include = TRUE, eval = TRUE}

datax <- data_diff_diff |> dplyr::select(
  dplyr::all_of(c("site", "contrast", "protein_Id",
                   "diff.protein",
                   "diff.site",
                   "modelName.site", "modelName.protein")))

palette <- c("black","orange")
palette <- setNames(palette, c("Linear_Model_moderated", "Imputed_Mean_moderated"))


xd <- prolfqua::scatter_plotly(
  datax,
  proteinID = "site",
  dx = "diff.protein",
  dy = "diff.site",
  contrast = "contrast",
  color = "modelName.site",
  palette = palette,
  title_size = 14,
  group = "BB")

xd <- lapply(xd, plotly::highlight , off = "plotly_doubleclick")
nrow <- ceiling(length(xd) / 4)
plotly::subplot(xd, shareX = TRUE, shareY = TRUE, nrows = nrow)

```


(ref:volcanoplot)  Volcano plot showing $-\log_{10}$ transformed FDR as a function of the protein-level adjusted difference between groups. The red line indicates the $-log_{10}(FDR)$ threshold of FDR = `r grp2$processing_options$FDR_threshold`, while the green lines represent the difference thresholds of minus and plus `r grp2$processing_options$diff_threshold`. Orange dots indicate differences and FDRs that were estimated using missing value imputation. This plot highlights phosphorylation sites with significant changes in usage (DPU) independent of protein abundance changes.


```{r volcanoplot, fig.cap = "(ref:volcanoplot)", fig.width=9, fig.height=7, include = TRUE, eval = TRUE}
datax <- data_diff_diff |> dplyr::select(
  all_of(c("site", "protein_Id",
           "contrast",
           "modelName.site",
           "diff_diff",
           "FDR_I")))
palette <- c("black", "orange")
palette <- setNames(palette, c("Linear_Model_moderated", "Imputed_Mean_moderated"))  
xd <- prolfqua::volcano_plotly( 
  datax,
  proteinID = "site",
  effect = "diff_diff",
  significance = "FDR_I",
  contrast = "contrast",
  color = "modelName.site",
  palette = palette,
  xintercept = c(-grp2$processing_options$diff_threshold,
                 grp2$processing_options$diff_threshold),
  yintercept = grp2$processing_options$FDR_threshold,
  title_size = 14,
  group = "BB")

xd <- lapply(xd, plotly::highlight , off = "plotly_doubleclick")
nrow <- ceiling(length(xd) / 4)
plotly::subplot(xd, shareX = TRUE, shareY = TRUE, nrows = nrow)

```

# References
