---
title: "Motif-Based Enrichment Analysis: Kinase Activity Inference"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Motif-Based Enrichment Analysis: Kinase Activity Inference}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  message = TRUE,
  warning = FALSE
)
```

## Introduction

While PTM-SEA relies on curated databases like PTMsigDB, many phosphosites do not map to known substrates. Motif-based analysis provides a complementary approach by scanning the *sequence context* of observed phosphosites for known kinase consensus motifs (e.g., matching the `R-x-x-S/T` pattern for Basophilic kinases).

This vignette demonstrates how to:
1.  Load a database of kinase regex motifs.
2.  Scan your phosphoproteomics sequence windows for matches.
3.  Perform GSEA to identify enriched kinase motifs in your contrasts.

## Load Data

```{r load_data}
library(prophosqua)
library(fgsea)
library(clusterProfiler)
library(enrichplot)

# Load example data (same as PTM-SEA vignette)
example_path <- here::here("data", "combined_test_diff_example.rds")
example_data <- readRDS(example_path)

cat("Data dimensions:", nrow(example_data), "rows x", ncol(example_data), "columns\n")
```

## Load and Define Motifs

We use `get_kinase_motifs()` to retrieve a default set of consensus patterns (e.g., from literature/Scansite/ELM). You can also add your own.

```{r load_motifs}
# Load kinase motifs (internal database + optional user extensions)
motif_db <- get_kinase_motifs()

# Example of adding a custom motif
my_motif <- data.frame(
  kinase_group = "Custom",
  motif_name = "MySpecialKinase",
  pattern = "R..S..[DE]",
  description = "Custom motif",
  stringsAsFactors = FALSE
)
motif_db <- get_kinase_motifs(extra_motifs = my_motif)

cat("Loaded", nrow(motif_db), "kinase motifs for scanning.\n")
print(head(motif_db))
```

## Motif Scanning

Instead of relying on exact PTMsigDB matches (which often have low overlap), we scan our *observed* sequence windows for these kinase motifs.

```{r scan_sequences}
# Get unique sequences from our data
# Ensure we use 15-mers if possible, or whatever length is appropriate.
# Default scanning assumes the central residue (pos 8) is the phosphosite.
our_sequences <- unique(toupper(trimws(example_data$SequenceWindow)))

# Scan for motifs
# center_pos = 8 ensures we only count matches where the motif overlaps the actual phosphosite
motif_matches <- scan_motifs(our_sequences, motif_db = motif_db, center_pos = 8)

cat("Scanning Results:\n")
cat("Found", nrow(motif_matches), "matches covering", length(unique(motif_matches$gene)), "unique sites.\n")

# Inspect top motifs
top_motifs <- head(sort(table(motif_matches$term), decreasing = TRUE), 10)
print(top_motifs)
```

The result `motif_matches` matches the `TERM2GENE` format required by `clusterProfiler`:
- `term`: The motif/kinase name.
- `gene`: The site ID (Sequence + "-p").

## Prepare Data (DPA/DPU)

We prepare the data ranking just like in standard PTM-SEA.

```{r prep_rank}
# Prepare DPA data (Differential PTM Abundance)
prep_dpa <- ptmsea_data_prep(
  data = example_data,
  stat_column = "statistic.site",
  seq_window_col = "SequenceWindow",
  contrast_col = "contrast",
  trim_to = "15"
)

# Prepare DPU data (Differential PTM Usage - protein normalized)
prep_dpu <- ptmsea_data_prep(
  data = example_data,
  stat_column = "tstatistic_I",
  seq_window_col = "SequenceWindow",
  contrast_col = "contrast",
  trim_to = "15"
)

print(names(prep_dpu))
```

## Run Motif GSEA

We use `run_motif_gsea` to perform enrichment analysis.

```{r run_gsea}
# Run GSEA using the scanned motif sets
results_motif_dpa <- run_motif_gsea(
  ranks_list = prep_dpa$ranks,
  motif_term2gene = motif_matches, # generated by scan_motifs
  pvalueCutoff = 1.0, # Return ALL results for visualization
  min_size = 3,
  max_size = 5000 # Allow large motif sets (critical!)
)

cat("Significant Motif Sets (DPA) - p < 0.1:\n")
for (name in names(results_motif_dpa)) {
  res <- results_motif_dpa[[name]]
  if (!is.null(res)) {
    n_sig <- sum(res@result$p.adjust < 0.1)
    cat("  ", name, ":", n_sig, "significant motifs\n")
  }
}
```

## Visualize Results

### Dotplot of Significant Motifs

```{r plot_dotplot, fig.width=10, fig.height=8}
# Define significance threshold
sig_threshold <- 0.1

if (length(results_motif_dpa) > 0) {
  # Filter out null results
  valid_res <- results_motif_dpa[!sapply(results_motif_dpa, is.null)]

  if (length(valid_res) > 0) {
    # Merge results across contrasts
    merged_res <- merge_result(valid_res)

    # Check if there are any significant results
    has_significant <- any(merged_res@compareClusterResult$p.adjust < sig_threshold)

    if (has_significant) {
      # Dotplot showing significant motifs
      p <- enrichplot::dotplot(merged_res, showCategory = 15) +
        ggplot2::labs(title = "Kinase Motif Enrichment (DPA)",
                      subtitle = paste("Showing motifs with p.adjust <", sig_threshold)) +
        ggplot2::theme(axis.text.x = ggplot2::element_text(angle = 45, hjust = 1))
      print(p)
    } else {
      cat("No significant motif enrichments found at p.adjust <", sig_threshold, "\n")
    }
  }
}
```

### GSEA Plots for Significant Sets

```{r gsea_plots_significant, fig.width=8, fig.height=6}
for (contrast_name in names(results_motif_dpa)) {
  res <- results_motif_dpa[[contrast_name]]

  if (!is.null(res) && nrow(res@result) > 0) {
    # Filter to significant motifs only
    sig_motifs <- res@result$ID[res@result$p.adjust < sig_threshold]

    if (length(sig_motifs) > 0) {
      cat("\n#### Contrast:", contrast_name, "\n")
      cat("Found", length(sig_motifs), "significant motifs (p.adjust <", sig_threshold, ")\n\n")

      for (motif in sig_motifs) {
        # Get the p-value and NES for display
        motif_row <- res@result[res@result$ID == motif, ]
        nes <- round(motif_row$NES, 3)
        padj <- signif(motif_row$p.adjust, 3)

        p1 <- enrichplot::gseaplot2(
          res,
          geneSetID = motif,
          title = paste0(contrast_name, " - ", motif,
                        "\nNES=", nes, ", p.adj=", padj)
        )
        print(p1)
        cat("\n")
      }
    } else {
      cat("\n#### Contrast:", contrast_name, "\n")
      cat("No significant motifs at p.adjust <", sig_threshold, "\n\n")
    }
  }
}
```

## Session Info

```{r session_info}
sessionInfo()
```
