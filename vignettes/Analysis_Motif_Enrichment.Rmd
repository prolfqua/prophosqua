---
title: "Motif-Based Enrichment Analysis: Kinase Activity Inference"
output:
  bookdown::html_document2:
    code_folding: hide
    toc: true
    toc_float: true
vignette: >
  %\VignetteIndexEntry{Motif-Based Enrichment Analysis: Kinase Activity Inference}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  warning = FALSE
)
```

## Introduction

While PTM-SEA relies on curated databases like PTMsigDB, many phosphosites do not map to known substrates. Motif-based analysis provides a complementary approach by scanning the *sequence context* of observed phosphosites for known kinase consensus motifs (e.g., matching the `R-x-x-S/T` pattern for Basophilic kinases).

This vignette demonstrates how to:
1.  Load a database of kinase regex motifs.
2.  Scan your phosphoproteomics sequence windows for matches.
3.  Perform GSEA to identify enriched kinase motifs in your contrasts.

We analyze both DPA (Differential PTM Abundance) and DPU (Differential PTM Usage) results:

- **DPA results** show kinase activity changes including protein abundance effects
- **DPU results** show kinase activity changes independent of protein abundance

Comparing the two analyses helps identify whether observed kinase activity changes are driven by genuine signaling changes (DPU) or protein abundance effects (DPA only).

## Load Data

```{r load_data}
library(prophosqua)
library(clusterProfiler)
library(dplyr)
library(enrichplot)
library(fgsea)
library(purrr)

# Load example data (same as PTM-SEA vignette)
data("combined_test_diff_example", package = "prophosqua")
example_data <- combined_test_diff_example

data_info <- tibble(
  Property = c("Rows", "Columns", "Contrasts"),
  Value = c(nrow(example_data), ncol(example_data),
            paste(unique(example_data$contrast), collapse = ", "))
)
knitr::kable(data_info, caption = "Example Data")
```

## Load and Define Motifs

We use `get_kinase_motifs()` to retrieve a default set of consensus patterns (e.g., from literature/Scansite/ELM). You can also add your own.

```{r load_motifs}
# Load kinase motifs (internal database + optional user extensions)
motif_db <- get_kinase_motifs()

# Example of adding a custom motif
my_motif <- data.frame(
  kinase_group = "Custom",
  motif_name = "MySpecialKinase",
  pattern = "R..S..[DE]",
  description = "Custom motif",
  stringsAsFactors = FALSE
)
motif_db <- get_kinase_motifs(extra_motifs = my_motif)

knitr::kable(head(motif_db), caption = paste("Kinase Motifs (", nrow(motif_db), "total)"))
```

## Motif Scanning

Instead of relying on exact PTMsigDB matches (which often have low overlap), we scan our *observed* sequence windows for these kinase motifs.

```{r scan_sequences}
# Get unique sequences from our data
# Ensure we use 15-mers if possible, or whatever length is appropriate.
# Default scanning assumes the central residue (pos 8) is the phosphosite.
our_sequences <- unique(toupper(trimws(example_data$SequenceWindow)))

# Scan for motifs
# center_pos = 8 ensures we only count matches where the motif overlaps the actual phosphosite
motif_matches <- scan_motifs(our_sequences, motif_db = motif_db, center_pos = 8)

scan_info <- tibble(
  Metric = c("Total matches", "Unique sites"),
  Value = c(nrow(motif_matches), length(unique(motif_matches$gene)))
)
knitr::kable(scan_info, caption = "Scanning Results")

# Top motifs
top_motifs <- motif_matches |>
  count(term, name = "Count") |>
  arrange(desc(Count)) |>
  head(10) |>
  rename(Motif = term)
knitr::kable(top_motifs, caption = "Top 10 Motifs by Match Count")
```

The result `motif_matches` matches the `TERM2GENE` format required by `clusterProfiler`:
- `term`: The motif/kinase name.
- `gene`: The site ID (Sequence + "-p").

## DPA Analysis (Differential PTM Abundance)

DPA uses raw phosphosite fold changes, which include both true signaling changes and protein abundance effects.

### Prepare DPA Data

```{r prep_dpa}
# Prepare DPA data (Differential PTM Abundance)
prep_dpa <- ptmsea_data_prep(
  data = example_data,
  stat_column = "statistic.site",
  seq_window_col = "SequenceWindow",
  contrast_col = "contrast",
  trim_to = "15"
)

dpa_prep_info <- tibble(
  Contrast = names(prep_dpa$ranks),
  Sites = map_int(prep_dpa$ranks, length)
)
knitr::kable(dpa_prep_info, caption = "DPA Contrasts Prepared")
```

### DPA: Motif GSEA

```{r dpa_gsea}
# Run GSEA using the scanned motif sets
results_motif_dpa <- run_motif_gsea(
  ranks_list = prep_dpa$ranks,
  motif_term2gene = motif_matches,
  pvalueCutoff = 1.0,
  min_size = 3,
  max_size = 5000
)

dpa_gsea_info <- tibble(
  Contrast = names(results_motif_dpa),
  `Significant (FDR < 0.1)` = map_int(results_motif_dpa, ~sum(.x@result$p.adjust < 0.1))
)
knitr::kable(dpa_gsea_info, caption = "DPA Motif GSEA Results")
```

```{r dpa_gsea_plot, fig.width=14, fig.height=10}
valid_dpa <- results_motif_dpa[!sapply(results_motif_dpa, is.null)]
if (length(valid_dpa) > 0) {
  merged_dpa <- merge_result(valid_dpa)
  dotplot(merged_dpa, showCategory = 15,
          title = "DPA GSEA - Motif Enrichment (FDR < 0.1)") +
    ggplot2::theme(axis.text.x = ggplot2::element_text(angle = 45, hjust = 1))
}
```

```{r dpa_gsea_individual, fig.width=14, fig.height=10}
dpa_plots <- names(results_motif_dpa) |>
  map(function(ct) {
    res <- results_motif_dpa[[ct]]
    if (!is.null(res) && nrow(res@result) > 0) {
      dotplot(res, showCategory = 15, title = ct) +
        ggplot2::theme(axis.text.y = ggplot2::element_text(size = 8))
    } else {
      ggplot2::ggplot() +
        ggplot2::annotate("text", x = 0.5, y = 0.5, label = paste("No results for", ct)) +
        ggplot2::theme_void() +
        ggplot2::ggtitle(ct)
    }
  })
patchwork::wrap_plots(dpa_plots, ncol = 2)
```

## DPU Analysis (Differential PTM Usage)

DPU uses protein-normalized phosphosite fold changes, representing true stoichiometry changes independent of protein abundance.

### Prepare DPU Data

```{r prep_dpu}
# Prepare DPU data (Differential PTM Usage - protein normalized)
prep_dpu <- ptmsea_data_prep(
  data = example_data,
  stat_column = "tstatistic_I",
  seq_window_col = "SequenceWindow",
  contrast_col = "contrast",
  trim_to = "15"
)

dpu_prep_info <- tibble(
  Contrast = names(prep_dpu$ranks),
  Sites = map_int(prep_dpu$ranks, length)
)
knitr::kable(dpu_prep_info, caption = "DPU Contrasts Prepared")
```

### DPU: Motif GSEA

```{r dpu_gsea}
results_motif_dpu <- run_motif_gsea(
  ranks_list = prep_dpu$ranks,
  motif_term2gene = motif_matches,
  pvalueCutoff = 1.0,
  min_size = 3,
  max_size = 5000
)

dpu_gsea_info <- tibble(
  Contrast = names(results_motif_dpu),
  `Significant (FDR < 0.1)` = map_int(results_motif_dpu, ~sum(.x@result$p.adjust < 0.1))
)
knitr::kable(dpu_gsea_info, caption = "DPU Motif GSEA Results")
```

```{r dpu_gsea_plot, fig.width=14, fig.height=10}
valid_dpu <- results_motif_dpu[!sapply(results_motif_dpu, is.null)]
if (length(valid_dpu) > 0) {
  merged_dpu <- merge_result(valid_dpu)
  dotplot(merged_dpu, showCategory = 15,
          title = "DPU GSEA - Motif Enrichment (FDR < 0.1)") +
    ggplot2::theme(axis.text.x = ggplot2::element_text(angle = 45, hjust = 1))
}
```

```{r dpu_gsea_individual, fig.width=14, fig.height=10}
dpu_plots <- names(results_motif_dpu) |>
  map(function(ct) {
    res <- results_motif_dpu[[ct]]
    if (!is.null(res) && nrow(res@result) > 0) {
      dotplot(res, showCategory = 15, title = ct) +
        ggplot2::theme(axis.text.y = ggplot2::element_text(size = 8))
    } else {
      ggplot2::ggplot() +
        ggplot2::annotate("text", x = 0.5, y = 0.5, label = paste("No results for", ct)) +
        ggplot2::theme_void() +
        ggplot2::ggtitle(ct)
    }
  })
patchwork::wrap_plots(dpu_plots, ncol = 2)
```

## Diagnostics

```{r diagnostic_pvalues}
pval_diag <- names(results_motif_dpa) |>
  map_dfr(function(ct) {
    res <- results_motif_dpa[[ct]]@result
    tibble(
      Contrast = ct,
      `Min p-value` = signif(min(res$pvalue), 3),
      `p < 0.05` = sum(res$pvalue < 0.05),
      `p < 0.01` = sum(res$pvalue < 0.01),
      Total = nrow(res)
    )
  })
knitr::kable(pval_diag, caption = "Raw p-value Distribution (DPA)")
```

```{r show_top_motifs}
if (length(results_motif_dpa) > 0) {
  top_res <- results_motif_dpa[[1]]@result |>
    as_tibble() |>
    arrange(pvalue) |>
    head(10) |>
    select(ID, enrichmentScore, NES, pvalue, p.adjust, setSize) |>
    mutate(
      enrichmentScore = round(enrichmentScore, 3),
      NES = round(NES, 3),
      pvalue = signif(pvalue, 3),
      p.adjust = signif(p.adjust, 3)
    )
  knitr::kable(top_res,
    caption = paste("Top 10 Motifs by P-value (DPA,",
                    names(results_motif_dpa)[1], ")"))
}
```

### GSEA Enrichment Plot (Example)

```{r gsea_plots_dpa, fig.width=10, fig.height=6}
# Show single example for illustration
ct <- names(results_motif_dpa)[1]
res <- results_motif_dpa[[ct]]

if (!is.null(res) && nrow(res@result) > 0) {
  top_motif <- res@result |>
    as_tibble() |>
    arrange(pvalue) |>
    slice(1) |>
    pull(ID)

  row <- res@result |>
    as_tibble() |>
    filter(ID == top_motif)
  nes_val <- round(row$NES, 2)
  fdr <- signif(row$p.adjust, 2)

  gseaplot2(res, geneSetID = top_motif,
    title = paste0(ct, " - ", top_motif, " (NES=", nes_val, ", FDR=", fdr, ")"))
}
```

## Session Info

```{r session_info}
sessionInfo()
```
