---
title: "Supplementary Material"
output:
  pdf_document:
    keep_tex: true
    latex_engine: pdflatex
    toc: true
    number_sections: false
  bookdown::pdf_document2:
    keep_tex: true
    latex_engine: pdflatex
    toc: true
    number_sections: false
---


```{r setupglobal, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  warning = FALSE,
  fig.width = 10,
  fig.height = 6,
  dpi = 300
)

# Set working directory for analysis
wd <- here::here("inst", "PTM_analysis_example_v2")
dir.create(wd, recursive = TRUE, showWarnings = FALSE)
knitr::opts_knit$set(root.dir = wd)

# Load required libraries
suppressPackageStartupMessages({
  library(prolfquapp)
  library(prophosqua)
  library(tidyverse)
  library(ggseqlogo)
  library(here)
})
```

# Overview {#overview}

This supplementary material provides a complete, executable implementation of the computational protocol described in the main manuscript. The workflow demonstrates a comprehensive approach to analyzing post-translational modifications (PTMs) in the context of total protein expression changes, addressing one of the most challenging aspects of PTM analysis: distinguishing true signaling changes from protein abundance effects.

The analysis is strategically divided into two complementary parts that work together to provide a complete picture of PTM regulation:

**Part A**: Differential expression analysis using `prolfquapp` for individual datasets - This initial phase independently analyzes total proteome and PTM-enriched datasets to identify significant changes in protein and modification abundances. This step establishes the foundation for integrated analysis and ensures data quality.

**Part B**: Integration and analysis of PTM features using `prophosqua` - This advanced phase combines the results from Part A to distinguish between PTM changes caused by protein abundance changes versus true changes in modification stoichiometry (the fraction of protein molecules that are modified).

The integrated protocol demonstrates several key analytical concepts:

1. **Setup and data preparation** - Environment configuration and example data retrieval from publicly available datasets
2. **Differential expression analysis** - Statistical analysis of total proteome and PTM data using robust linear modeling approaches
3. **Data integration** - Combining PTM and protein-level results through careful matching and statistical frameworks
4. **Visualization** - N-to-C plots showing modification sites along protein sequences in their biological context
5. **Biological interpretation** - Sequence motif analysis for kinase prediction and pathway inference
6. **Reporting** - Automated generation of comprehensive analysis reports suitable for publication and data sharing

This workflow addresses several critical challenges in PTM analysis:

- **Confounding between protein and PTM levels**: A key challenge in PTM analysis is that apparent changes in modification levels can simply reflect changes in total protein abundance rather than true signaling alterations.
- **Missing data handling**: PTM datasets often have more missing values than total proteome data due to the lower abundance of modified peptides.
- **Statistical power considerations**: PTM experiments typically have lower statistical power due to the substoichiometric nature of modifications, requiring specialized statistical approaches.
- **Biological interpretation complexity**: Understanding whether observed changes represent meaningful biological signals requires integration with protein-level data and sequence context.

## Software Requirements

- **R version**: $\ge$ 4.0.0
- **Required packages**: 
  - `prolfqua` (doi:10.1021/acs.jproteome.2c00441) - Core statistical framework for proteomics data analysis
  - `prolfquapp` (doi:10.1021/acs.jproteome.4c00911) - Streamlined differential expression analysis pipeline
  - `prolfquappPTMreaders` (doi:10.5281/zenodo.15845243) - Specialized readers for PTM data formats
  - `prophosqua` (doi:10.5281/zenodo.15845272) - Integration and visualization of PTM and protein data
  - `tidyverse` (doi:10.21105/joss.01686) - Data manipulation and visualization tools
  - `ggseqlogo` (doi:10.32614/CRAN.package.ggseqlogo) - Sequence motif visualization
- **System requirements**: 8GB+ RAM (16GB+ recommended for large datasets), 5GB+ storage
- **Expected runtime**: 30 minutes to 2 hours depending on dataset size and number of fractions

**Note on computational requirements**: The analysis can be memory-intensive, particularly for large-scale experiments with extensive fractionation. Users working with very large datasets may need to process data in chunks or use high-memory computing resources.

---

# A. Differential expression analysis using `prolfquapp`

This section demonstrates how to perform **differential expression analysis (DEA)** on both total proteome and PTM-enriched proteome data using the `prolfquapp` package. The analysis provides the foundation for subsequent integration by establishing which proteins and PTM features show significant changes between experimental conditions.

## Conceptual Overview

Differential expression analysis in the context of PTM studies serves multiple critical purposes:

1. **Quality assessment**: Ensures that both total proteome and PTM datasets are of sufficient quality for integration
2. **Individual dataset analysis**: Provides standalone results for both protein and PTM changes
3. **Foundation for integration**: Generates the statistical results needed for subsequent DPU (Differential PTM Usage) analysis
4. **Validation**: Allows comparison with expected biological changes and literature findings

The analysis workflow handles several data types that represent different levels of PTM information:

1. **Total proteome data** - Overall protein expression changes that provide the normalization baseline for PTM analysis
2. **PTM-enriched data** - Post-translational modification changes (primarily phosphorylation in this example)
3. **Multi-site analysis** - Groups of modification sites that are analyzed together, useful for understanding coordinated regulation
4. **Single-site analysis** - Individual modification sites analyzed separately, providing the highest resolution view of PTM changes

The example dataset uses a factorial experimental design with genotype and timepoint factors, demonstrating how to handle complex experimental designs that are common in modern proteomics studies.

## Important Statistical Considerations

The differential expression analysis implements several statistical best practices:

- **Variance stabilization**: Log2 transformation and variance stabilizing normalization to ensure that statistical assumptions are met
- **Missing data handling**: Robust approaches to handle missing values without introducing bias
- **Multiple testing correction**: False discovery rate (FDR) control to manage the large number of statistical tests
- **Effect size estimation**: Focus on both statistical significance and biological relevance through fold change thresholds

## A.1 Downloading the example dataset

The first step is to download the example PTM dataset, which serves as a comprehensive demonstration of integrated PTM analysis. This dataset is derived from the Atg16l1 macrophage study by Maculins et al. (eLife 2021), investigating the role of autophagy in bacterial infection responses. The dataset contains both total proteome and PTM-enriched measurements from a well-designed factorial experiment with the following characteristics:

- **Experimental design**: 2×3 factorial (Genotype: WT/KO × Timepoint: Uninfected/Early/Late infection)
- **Biological context**: Macrophage responses to Shigella infection in wild-type vs Atg16l1-knockout cells
- **Technical approach**: TMT 11-plex labeling for precise quantification across conditions
- **Data types**: Total proteome and phospho-enriched proteome measurements

This dataset is particularly valuable for demonstrating PTM analysis concepts because the Atg16l1 knockout creates both direct protein abundance changes (loss of Atg16l1 itself) and secondary effects on autophagy-related signaling pathways.

```{r a1getthedata}
zip_url  <- "https://gitlab.bfabric.org/wolski/ptm_example/-/archive/main/ptm_example-main.zip"
destfile <- "ptm_example-main.zip"

# Download, unzip and delete
download.file(zip_url, destfile, mode = "wb")
unzip(destfile, exdir = ".")
unlink(destfile)
do_dea <- TRUE
```

### A.2 Setting up prolfquapp scripts

The `prolfquapp` package provides shell scripts for running differential expression analysis. This command copies these scripts to the current working directory.

```{bash a2getscritps, results="hide", eval=do_dea}
R --vanilla -e "library(prolfquapp); copy_shell_script(workdir = '.')"
```

### A.3 Creating sample annotation

Sample annotation is the foundation of any meaningful differential expression analysis, serving as the bridge between raw mass spectrometry files and biological interpretation. The annotation file performs several critical functions:

1. **File mapping**: Associates each raw data file with specific experimental conditions
2. **Experimental design definition**: Explicitly defines the factors and levels in the experiment
3. **Statistical modeling preparation**: Provides the structure needed for linear modeling and contrast generation
4. **Quality control**: Enables identification of mislabeled samples or batch effects

In TMT experiments, proper sample annotation is particularly crucial because all samples are analyzed together in a single LC-MS run, making it impossible to retrospectively correct annotation errors. The annotation must accurately capture:

- **Biological factors**: Genotype, treatment, timepoint, etc.
- **Technical factors**: TMT channel, batch, fraction (if applicable)
- **Blocking factors**: Any sources of systematic variation that should be accounted for in the statistical model

The `prolfquapp` package automates much of the annotation process by parsing informative sample names, but manual verification and enhancement are often necessary for complex experimental designs.

### A.3.1 Creating the initial dataset file

This command processes FragPipe output files to create a dataset annotation file that maps sample names to their experimental conditions.

```{bash a3createdataset, results="hide", eval=do_dea}
./prolfqua_dataset.sh --indir ptm_example-main/data_total/FP_22/ \
  --dataset "ptm_example-main/data_total/dataset.tsv" \
  --software prolfquapp.FP_TMT
```

### A.3.2 Adding experimental factors and contrasts

The sample names contain encoded information about the experimental design. This code:

1. **Parses sample names** to extract genotype and timepoint information
2. **Creates factorial contrasts** for statistical analysis
3. **Generates comparison groups** for differential expression testing

```{r a3createcontrasts}

annot <- readr::read_tsv("ptm_example-main/data_total/dataset.tsv")
knitr::kable(head(annot))
annot <- annot |> tidyr::separate("name", c("Genotype", "Timepoint", NA), sep = "_", remove = FALSE)
annot$group <- NULL
annot$subject <- NULL
annot$CONTROL <- NULL
annot2 <- prolfqua::annotation_add_contrasts(
  annot, "Genotype", "Timepoint" ,
  decreasing = TRUE, interactions = FALSE)$annot
knitr::kable(head(annot2))

write_tsv(annot2, "dataset_with_contrasts.tsv")

```

The file `dataset_with_contrasts.tsv` is the final dataset file that will be used for the differential expression analysis.

[Download the dataset with contrasts file](dataset_with_contrasts.tsv)

## A.4 Running DEA analysis of total proteome

This analysis examines changes in overall protein abundance between experimental conditions. The command:

- **`-i`**: Specifies input directory with FragPipe results
- **`-d`**: Uses the annotated dataset file
- **`-y`**: Applies configuration settings
- **`-w`**: Sets working directory name
- **`-s`**: Specifies software format (FragPipe TMT)

```{bash a4runDEAtotal, echo = TRUE, results="hide", eval=do_dea}
./prolfqua_yaml.sh -y config.yaml
./prolfqua_dea.sh -i ptm_example-main/data_total/FP_22 \
  -d dataset_with_contrasts.tsv \
  -y config.yaml \
  -w total_proteome \
  -s prolfquapp.FP_TMT
```

After running the differential expression analysis, the results are stored in a time-stamped directory. This code constructs the path to the results directory using the `prolfquapp::zipdir_name()` function, which follows the standard naming convention for DEA results.

```{r a4dirtotal}
dir_total <- file.path(".", prolfquapp::zipdir_name("DEA", workunit_id = "total_proteome"))

```

The results of the total proteome analysis can be found in the [DEA report](`r dir_total`/index.html).


## A.5 Running DEA analysis of the enriched proteomes

PTM-enriched proteomes provide information about post-translational modifications. We analyze this data in two ways:

### A.5.1 Differential expression analysis for multi-site output

Multi-site analysis examines changes in modification patterns across multiple sites on the same protein. This is useful for understanding global modification changes.

```{bash a5multisite,results="hide", eval=do_dea}
./prolfqua_dea.sh -i ptm_example-main/data_ptm/FP_22 \
  -d dataset_with_contrasts.tsv \
  -y config.yaml \
  -w multisite_PTM \
  -s prolfquappPTMreaders.FP_multisite
```

```{r a5dirmultisite}
dir_multisite <- file.path(".", prolfquapp::zipdir_name("DEA", workunit_id = "multisite_PTM"))
```


The results of the multi-site analysis can be found in the [DEA report](`r dir_multisite`/index.html).

### A.5.2 Differential expression analysis for single-site output

Single-site analysis examines changes at individual modification sites. This provides site-specific information about which particular amino acids are modified under different conditions.

```{bash a5singlesite,eval=do_dea, results="hide"}
./prolfqua_dea.sh -i ptm_example-main/data_ptm/FP_22 \
  -d dataset_with_contrasts.tsv \
  -y config.yaml \
  -w singlesite_PTM \
  -s prolfquappPTMreaders.FP_singlesite
```

```{r a5dirsinglesite}
dir_singlesite <- file.path(".", prolfquapp::zipdir_name("DEA", workunit_id = "singlesite_PTM"))
```

The results of the single-site analysis can be found in the [DEA report](`r dir_singlesite`/index.html).

## A.6 Analysis Output

After running these analyses, you will have:

1. **Total proteome results** - Protein-level differential expression - [DEA report](`r dir_total`/index.html)
2. **Multi-site PTM results** - Modification pattern changes - [DEA report](`r dir_multisite`/index.html)
3. **Single-site PTM results** - Individual modification site changes - [DEA report](`r dir_singlesite`/index.html)

Each analysis produces:
- Statistical tables with p-values and fold changes
- Visualization plots
- Quality control reports
- Excel files with comprehensive results

These results can be further integrated using the `prophosqua` package for combined analysis of total proteome and PTM data.

# B. Integration and analysis of PTM features using `prophosqua`

This section demonstrates the core innovation of integrated PTM analysis: how to **combine PTM and total proteome data** to distinguish between different types of biological changes. This analysis addresses the fundamental challenge in PTM studies - determining whether observed changes in modification levels represent true signaling alterations or simply reflect changes in protein abundance.

## Conceptual Framework: Expression vs. Usage

The integration analysis is built around a key conceptual distinction that is critical for biological interpretation:

**Expression Changes**: Changes in the absolute amount of modified peptides, which can occur due to:
- Changes in total protein abundance (more protein = more modified peptides)
- Changes in modification stoichiometry (same protein, different modification levels)
- A combination of both factors

**Usage Changes**: Changes in the **fraction** of protein molecules that carry a modification, representing true alterations in signaling activity, kinase/phosphatase balance, or regulatory pathway activation.

This workflow performs two complementary types of analysis:

1. **Differential PTM Feature Expression (DPE)** - Identifies sites where the absolute amount of modification changes, regardless of the underlying cause. This analysis is similar to standard differential expression but applied to PTM features.

2. **Differential PTM Feature Usage (DPU)** - Identifies sites where the modification stoichiometry changes after accounting for protein abundance changes. This analysis reveals sites where signaling activity is truly altered.

The biological interpretation framework:
- **DPE+ only**: Changes driven primarily by protein abundance alterations
- **DPU+ only**: True signaling changes with stable protein levels  
- **DPE+ and DPU+**: Amplified signaling where both protein and modification efficiency increase
- **DPE- and DPU+**: Compensatory regulation where modification increases despite protein decreases

## Visualization Strategy

The analysis creates N-to-C plots (N-terminus to C-terminus) that provide an intuitive visualization of modification patterns along protein sequences. These plots show:
- **Protein context**: Where modifications occur relative to protein domains and structure
- **Multiple modifications**: How different sites on the same protein are coordinately or independently regulated
- **Statistical significance**: Clear indication of which changes are statistically reliable
- **Effect sizes**: Magnitude of changes in both expression and usage terms

```{r b1setup2, include=FALSE}
library(prophosqua)
```

## B.1 Data Setup and Configuration


This section defines the project identifiers and analysis type. The `ptm_feature` parameter determines whether we analyze single phosphorylation sites or multi-site patterns.

We run the single-site analysis, to run the multi-site analysis, change the `ptm_feature` parameter to `multisite`.

```{r b1specifyinputs}
wu_id <- "CustomPhosphoAnalysis"
fgcz_project <- "PTM_analysis"
oid_fgcz <- "fgcz_project"
ptm_feature <- "singlesite"
datetoday <- format(Sys.Date(), "%Y%m%d") # 
#datetoday <- "20250709"
#project_dir <- "inst/PTM_analysis_example_v2"
project_dir <- "."
tot_file <- file.path(
  project_dir, 
  paste0("DEA_", datetoday, "_",
  "WUtotal_proteome_vsn/Results_WU_total_proteome/DE_WUtotal_proteome.xlsx")
)

if (ptm_feature == "multisite") {
  ptm_file <- file.path(
    project_dir, 
    paste0("DEA_", datetoday, "_",
    "WUmultisite_PTM_vsn/Results_WU_multisite_PTM/DE_WUmultisite_PTM.xlsx")
  )
} else if (ptm_feature == "singlesite") {
  ptm_file <- file.path(
    project_dir,
    paste0("DEA_", datetoday, "_",
    "WUsinglesite_PTM_vsn/Results_WU_singlesite_PTM/DE_WUsinglesite_PTM.xlsx")
  )
}

# Directory paths
stopifnot(file.exists(tot_file))
stopifnot(file.exists(ptm_file))
```

## B.2 Creating results directory

Sets up the output directory with a timestamped name for organizing results.

```{r b2createoutputdir}
descri <- wu_id
res_dir <- file.path(
  project_dir, 
  paste0(fgcz_project, "_", datetoday, "_", ptm_feature, "_", descri)
)
# Create results directory
if (!dir.exists(res_dir)) {
  dir.create(res_dir, recursive = TRUE)
}

```

## B.3 Defining analysis parameters

Sets the statistical thresholds and column mapping for joining total proteome and PTM data.

```{r b3defineanalysisparameters}
fdr_threshold <- 0.01
join_column <- c(
  "fasta.id" = "protein_Id", 
  "contrast", 
  "description", 
  "protein_length"
)
suffix_a <- ".site"
suffix_b <- ".protein"
```

## B.4 Loading and preprocessing data

Loads both total proteome and PTM data, filters out contaminants, and ensures data quality.

```{r b4loaddata}
required_cols <- c("protein_Id", "protein_length", "contrast")
tot_res <- load_and_preprocess_data(tot_file, required_cols)
tot_res <- filter_contaminants(tot_res)
phospho_res <- load_and_preprocess_data(ptm_file, required_cols)
phospho_res <- filter_contaminants(phospho_res)
```

## B.5 Combining PTM and total proteome data

The data integration step is critical for enabling DPU analysis and represents one of the most important technical aspects of the workflow. This step joins phosphorylation site data with total protein data to create a unified dataset where each PTM feature is linked to its corresponding protein-level measurements.

### Integration Challenges and Solutions

Several technical challenges must be addressed during integration:

1. **Protein ID matching**: Ensuring that protein identifiers are consistent between datasets, which can be complicated by different database versions or protein inference algorithms.

2. **Missing data patterns**: PTM datasets typically have more missing values than total proteome data due to the lower abundance of modified peptides. The integration must handle cases where PTM sites are detected but the corresponding protein is not, or vice versa.

3. **Statistical design consistency**: Both datasets must be analyzed using the same experimental design and contrast definitions to ensure meaningful comparisons.

4. **Data structure alignment**: PTM features (sites or peptidoforms) must be properly mapped to their parent proteins, accounting for the fact that multiple PTM features can map to the same protein.

The `left_join` operation used here ensures that all PTM features are retained in the analysis, even if their parent proteins were not detected in the total proteome experiment. This approach maximizes the information content while still allowing protein normalization where possible.

```{r b5combinedata}
combined_site_prot <- dplyr::left_join(
  phospho_res,
  tot_res,
  by = join_column,
  suffix = c(suffix_a, suffix_b)
)

```

### B.5.1 Check the match rate between PTM sites and proteins

Check the match rate between PTM sites and proteins, that is the number of PTM sites that have a protein match divided by the total number of PTM sites.

```{r b5matchrate}

# Calculate match rate by contrast
match_rates <- combined_site_prot |>
  group_by(contrast) |>
  summarize(
    total_sites = n(),
    matched_sites = sum(!is.na(diff.protein)),
    match_rate = round(matched_sites / total_sites * 100, 1)
  )

knitr::kable(
  match_rates,
  col.names = c("Contrast", "Total Sites", "Matched Sites", "Match Rate"),
  caption = "Match rates between PTM sites and proteins."
)


```

## B.6 Visualizing PTM Feature Expression (DPE)

This analysis examines how much each phosphorylation site changes in abundance between experimental conditions, independent of changes in the total protein.

### B.6.1 Creating N-to-C expression plots

Generates plots showing phosphorylation sites along protein backbones with their differential expression values. The plots distinguish between multi-site and single-site analyses.

```{r b6makeplot, results='hide'}
if (ptm_feature == "multisite") {
  combined_site_prot_long <- explode_multisites(combined_site_prot)
  plot_data <- n_to_c_expression(combined_site_prot_long, "KO_vs_WT_at_Uninfect", 0.01)
} else if (ptm_feature == "singlesite") {
  plot_data <- n_to_c_expression(combined_site_prot, "KO_vs_WT_at_Uninfect", 0.01)
}
```


### B.6.2 Protein Q64337

Shows the N-to-C plot for protein Q64337, another example of how phosphorylation sites change in expression.

```{r b6plotQ64337, fig.cap="Q64337"}
x1 <- which(plot_data$protein_Id == "Q64337")
plot_data$plot[[x1]]
knitr::kable(plot_data$data[[x1]])
```

### B.6.3 Saving expression plots

Exports all N-to-C expression plots to a PDF file for further analysis and presentation.

```{r b6saveexpressionplots}
# Create plots
pdf(file.path(res_dir, "Site_differential_Expression.pdf"))
for (i in seq_len(100)) {
  print(plot_data$plot[[i]])
}
dev.off()
```

## B.7 Differential PTM Feature Usage (DPU)


The `test_diff` function implements a statistical framework for calculating differential PTM usage (DPU) that accounts for both PTM and protein-level changes. The analysis involves three key mathematical components:

1. Effect Size Calculation ($\Delta I$)
2. Standard Error Propagation ($SE_I$)
3. Degrees of Freedom Calculation ($df_I$)

The differential PTM usage effect size is calculated as the difference between PTM and protein log2 fold changes:

$$
\Delta_I = \log_2FC_{PTM} - \log_2FC_{Protein}
$$

This represents the protein-normalized change in PTM abundance, where:
- **Positive values** indicate increased modification stoichiometry (higher fraction of protein is modified)
- **Negative values** indicate decreased modification stoichiometry (lower fraction of protein is modified)
- **Zero values** indicate no change in modification stoichiometry relative to protein expression


The combined standard error accounts for uncertainty in both PTM and protein measurements:

$$
SE_I = \sqrt{SE_{PTM}^2 + SE_{Protein}^2}
$$

This error propagation ensures that the statistical significance of usage changes reflects uncertainty from both datasets, providing a more robust assessment of the reliability of the observed changes.


The effective degrees of freedom for the combined test are calculated using Welch's approximation:

$$
df_I = (SE_{PTM}^2 + SE_{Protein}^2)^2 \biggm/ (\frac{SE_{PTM}^4}{DF_{PTM}} + \frac{SE_{Protein}^4}{DF_{Protein}})
$$

This provides appropriate statistical power for the combined analysis while accounting for potentially different sample sizes and variances between PTM and protein measurements. The Welch approximation is particularly important when the two datasets have different experimental designs or sample sizes.

Using these calculated parameters, a t-statistic is computed:

$$t = \frac{\Delta_I}{SE_I}$$

The corresponding p-value is determined using the t-distribution with dfI degrees of freedom, and multiple testing correction (e.g., Benjamini-Hochberg FDR) is applied across all tested sites.

## B.8 Differential PTM-feature Usage (DPU) Analysis


The `test_diff` function calculates the difference of differences between PTM and total proteome data, revealing site-specific usage changes.

```{r b8computeptmusage}
combined_test_diff <- prophosqua::test_diff(phospho_res, tot_res, join_column = join_column)
```

### B.8.1 Creating N-to-C usage plots

Generates plots showing differential usage of phosphorylation sites. These plots reveal which sites are being used more or less actively, independent of total protein changes.

```{r b9generateplotsusage, results='hide', message=FALSE}
if (ptm_feature == "multisite") {
  combined_test_diff_long <- explode_multisites(combined_test_diff)
  plot_data <- n_to_c_usage(combined_test_diff_long, "KO_vs_WT_at_Uninfect", FDR_threshold = 0.05)
} else if (ptm_feature == "singlesite") {
  plot_data <- n_to_c_usage(combined_test_diff, "KO_vs_WT_at_Uninfect", FDR_threshold = 0.05)
}
```


### B.8.2 PTM Feature Usage for Protein `Q64337`

Shows how the usage of phosphorylation sites on protein `Q64337` changes between experimental conditions.

```{r b8showusageQ64337, fig.cap="PTM feature usage for Q64337"}
x1 <- which(plot_data$protein_Id == "Q64337")
plot_data$plot[[x1]]
knitr::kable(plot_data$data[[x1]])
```

### B.8.3 Saving usage plots

Exports all N-to-C usage plots to a PDF file.

```{r b8saveusageplots}
pdf(file.path(res_dir, "Site_differential_UsageChange.pdf"))
for (i in seq_len(100)) {
  print(plot_data$plot[[i]])
}
dev.off()
```

## B.9 Protein PTM Integration Report Generation

### B.9.1 Setting up report configuration

Creates the configuration object needed for generating the interactive HTML report.

```{r b9renderreportexpression, message=FALSE, eval=do_dea}
drumm <- prolfquapp::make_DEA_config_R6(
  PROJECTID = fgcz_project,
  ORDERID = oid_fgcz,
  WORKUNITID = descri
)
# Copy integration files
prophosqua::copy_phospho_integration()
```

### B.9.2 Rendering the HTML report

Generates an interactive HTML report with comprehensive analysis results, including tables, plots, and statistical summaries.

```{r b9renderdocument, eval = TRUE, results="hide", eval=do_dea}
# Render HTML report
rmarkdown::render(
  "_Overview_PhosphoAndIntegration_site.Rmd",
  params = list(
    data = combined_test_diff,
    grp = drumm
  ),
  output_format = bookdown::html_document2(
    toc = TRUE, 
    toc_float = TRUE
  ),
  envir = new.env(parent = globalenv())
)



# Copy HTML report to results directory
file.copy(
  from = "_Overview_PhosphoAndIntegration_site.html",
  to = file.path(
    res_dir, 
    "Result_phosphoAndTotalIntegration.html"
  )
)
```

## B.10 Saving results to Excel

Exports the integrated analysis results to an Excel file for further analysis and sharing.

```{r storeptmusagexlsx}
excel_result_list <- list(
  combinedStats = combined_test_diff,
  combinedSiteProteinData = combined_site_prot
)
writexl::write_xlsx(
  excel_result_list,
  path = file.path(
    res_dir, 
    "Result_phosphoAndTotalIntegration.xlsx"
  )
)
```

## B.11 Results Summary

The analysis produces several output files that can be accessed through the links below:

```{r b11linktoreport, echo=FALSE, results='asis'}
html_path <- file.path(
  res_dir, 
  "Result_phosphoAndTotalIntegration.html"
)
xlsx_path <- file.path(
  res_dir, 
  "Result_phosphoAndTotalIntegration.xlsx"
)
plot_pdf_expression <- file.path(
  res_dir, 
  "Site_differential_Expression.pdf"
)
plot_pdf_usage <- file.path(
  res_dir, 
  "Site_differential_UsageChange.pdf"
)

cat(sprintf(
  '- [View the phospho‐integration report](%s){target="_blank"}\n',
  html_path
))
cat(sprintf(
  '- [Download the phospho+total integration results (Excel)](%s){target="_blank"}\n',
  xlsx_path
))

cat(sprintf(
  '- [View n_to_c plots of differential ptm-feature expression](%s){target="_blank"}\n',
  plot_pdf_expression
))
cat(sprintf(
  '- [View n_to_c plots of differential ptm-feature usage](%s){target="_blank"}\n',
  plot_pdf_usage
))
```

## B.12 Key Insights from This Analysis

This integrated approach provides several critical advantages over traditional PTM analysis methods:

1. **Distinguishes expression vs. usage changes** - The fundamental innovation of this approach is the ability to separate changes due to protein abundance from true changes in modification stoichiometry. This distinction is crucial for understanding the biological meaning of PTM changes.

2. **Site-specific information** - By analyzing individual modification sites, the approach identifies which specific amino acids are modified under different conditions, providing precise targets for follow-up functional studies.

3. **Biological interpretation framework** - The DPE vs. DPU comparison helps researchers understand whether observed changes reflect protein regulation (transcriptional/translational) or signaling pathway activation (kinase/phosphatase activity).

4. **Visual representation** - N-to-C plots provide an intuitive visualization that places modification patterns in their protein sequence context, facilitating interpretation by showing modifications relative to known domains and functional regions.

5. **Statistical rigor** - The approach properly handles the statistical challenges of PTM analysis, including missing data, multiple testing correction, and appropriate error propagation for combined analyses.

## Practical Applications

The results from this analysis can be used to:

- **Identify key regulatory sites**: Sites showing significant DPU changes represent high-priority targets for functional validation
- **Understand pathway dynamics**: Coordinated changes in multiple sites on the same protein may indicate pathway-level regulation
- **Prioritize follow-up experiments**: Motif analysis results can guide kinase inhibitor studies or targeted mutagenesis
- **Generate biological hypotheses**: Integration of PTM and protein data provides mechanistic insights into how cellular perturbations affect signaling networks
- **Support publication**: The comprehensive analysis provides robust statistical support and clear visualizations suitable for high-impact publications

# C. Sequence Logo Analysis of Modified Sites

This section provides biological interpretation of the PTM changes by analyzing sequence motifs around significantly modified sites to identify potential kinase recognition patterns. This analysis bridges the gap between statistical significance and biological mechanism by leveraging the well-established principle that kinases recognize specific amino acid sequence patterns around their target sites.

## Biological Rationale for Motif Analysis

Protein kinases exhibit sequence specificity, preferentially phosphorylating sites that match their recognition motifs. These motifs typically encompass positions -5 to +4 relative to the phosphorylation site, with certain positions being more critical than others. By analyzing the sequence patterns of significantly regulated sites, we can:

1. **Identify active kinases**: Sites that share similar motifs likely represent targets of the same kinase or kinase family
2. **Understand pathway activation**: Different kinase families are associated with different signaling pathways
3. **Predict functional consequences**: Kinase-specific phosphorylation often has predictable effects on protein function
4. **Generate testable hypotheses**: Motif predictions can guide follow-up experiments with kinase inhibitors or knockdowns

## Analysis Strategy

The sequence logo analysis follows a systematic approach designed to maximize biological insights:

1. **Significance filtering** - Focuses on sites with strong statistical evidence (FDR_I < 0.05 and fold change > 0.58), ensuring that motif analysis is performed on the most reliable signals
2. **Directional grouping** - Separates upregulated and downregulated sites for each contrast, as different kinase families may be activated or inhibited under different conditions
3. **Sequence preparation** - Uses the `SequenceWindow` column containing amino acid sequences around each phosphorylation site, typically spanning 7-15 amino acids centered on the modification
4. **Multi-panel visualization** - Creates sequence logos for different groups in a 2-column layout for easy comparison
5. **Probability-based display** - Shows amino acid frequencies rather than information content, providing intuitive interpretation of motif strength

## Interpretation Guidelines

The resulting sequence logos should be interpreted in the context of known kinase specificity patterns:

- **Position -3, -2**: Often contain basic residues (R, K) for kinases like PKA, PKC, and CaMKII
- **Position +1**: Proline is common for MAPK family kinases
- **Position +3**: Acidic residues (D, E) are characteristic of casein kinase 2 (CK2)
- **Hydrophobic patterns**: May indicate kinases with different specificity requirements

The analysis focuses on sites with strong statistical evidence of differential usage (FDR_I < 0.01) to ensure that motif patterns reflect genuine biological changes rather than technical artifacts.

```{r filterdataforseqlogoplotting}
library(ggseqlogo)

# Filter for significantly regulated sites (FDR_I < 0.05)
log_2FC_threshold <- 0.58


significant_sites <- combined_test_diff |>
  filter(
    FDR_I < 0.05, 
    abs(diff_diff) > log_2FC_threshold, 
    !is.na(posInProtein), 
    grepl("^KO_vs_WT", contrast),
    !grepl("^_", SequenceWindow),
    !grepl("_$", SequenceWindow)
  ) |>
  dplyr::mutate(
    regulation = case_when(
      diff_diff > 0 ~ "upregulated",
      diff_diff < 0 ~ "downregulated",
      TRUE ~ "no_change"
    )
  )

with(significant_sites, table(contrast, regulation, modAA)) |>
  knitr::kable(caption = "number of significantly regulated sites")

```

The sequence logos reveal consensus motifs that can help identify which kinases are responsible for the observed phosphorylation changes.

```{r c1makeseqlog}
# Get 7th character from each sequence window
significant_sites$seventh_chars <- toupper(substr(significant_sites$SequenceWindow, 8, 8))
significant_sites <- significant_sites |> filter(seventh_chars == modAA)
```


```{r c1makeseqlog2S, fig.width=9, fig.height=12, fig.cap="Sequence logos of significantly regulated phosphorylation sites on Serine (S)"}
seq_list <- significant_sites |> filter(modAA == "S") |>
  mutate(.grp = paste(contrast, regulation,  sep = "_")) |>
  group_by(.grp) |>
  summarize(
    seqs = list(toupper(SequenceWindow)),
    .groups = "drop"
  ) |>
  with(setNames(seqs, .grp))

ggseqlogo(
  seq_list,
  ncol = 2,
  seq_type = "aa", 
  method = "probability"
)

```



```{r c1makeseqlog2T, fig.width=9, fig.height=12, fig.cap="Sequence logos of significantly regulated phosphorylation sites on Threonine (T)"}
seq_list <- significant_sites |> filter(modAA == "T") |>
  mutate(.grp = paste(contrast, regulation,  sep = "_")) |>
  group_by(.grp) |>
  summarize(
    seqs = list(toupper(SequenceWindow)), 
    .groups = "drop"
  ) |>
  with(setNames(seqs, .grp))

ggseqlogo(
  seq_list,
  ncol = 2,
  seq_type = "aa", 
  method = "probability"
)

```


## C.2 Interpreting the sequence logos

The sequence logos show:

- **Y-axis**: Amino acid frequency (0-1 scale)
- **X-axis**: Position relative to the phosphorylation site (center)
- **Letter height**: Frequency of each amino acid at that position
- **Color coding**: Different amino acid types (hydrophobic, polar, charged, etc.)

**Key insights to look for:**

1. **Consensus motifs** - Highly conserved amino acids at specific positions
2. **Kinase preferences** - Different patterns for up vs. downregulated sites
3. **Position-specific preferences** - Certain amino acids preferred at -3, -2, +1, +2 positions
4. **Known kinase motifs** - Comparison with established kinase recognition patterns

**Common kinase motifs include:**

- **PKA/PKG**: R-R-X-S/T (arginine at -3, -2 positions)
- **PKC**: R-X-S/T-X-R (arginine at -3, +2 positions)  
- **CK2**: S/T-X-X-E/D (acidic residue at +3 position)
- **MAPK**: P-X-S/T-P (proline at -2, +1 positions)

This analysis helps identify the signaling pathways and kinases responsible for the observed phosphorylation changes in your experimental conditions.

# D Summary of Complete Workflow

This supplementary material has demonstrated the complete implementation of the computational protocol for integrated PTM and total proteome analysis. The workflow successfully:

1. **Performed differential expression analysis** on total proteome and PTM datasets
2. **Integrated the datasets** to enable comparative analysis
3. **Distinguished expression vs. usage changes** through DPE and DPU analysis
4. **Identified sequence motifs** for kinase prediction
5. **Generated comprehensive visualizations** and reports

## D.1 Biological Interpretation Framework

### D.1.1 DPE vs. DPU Interpretation:

- **DPE+ only**: PTM changes due to protein expression changes
- **DPU+ only**: True changes in modification stoichiometry
- **DPE+ and DPU+**: Enhanced modification beyond protein expression
- **DPE- and DPU+**: Selective modification maintenance despite protein reduction


### D.1.2 Quality Control Metrics:

- **Match rate > 80 $\%$**: Good integration between datasets
- **FDR < 0.05**: Standard significance threshold
- **|log_2FC_threshold| > 0.58**: Minimum 1.5-fold change threshold

## Troubleshooting Common Issues

This section addresses the most frequently encountered problems in integrated PTM analysis and provides practical solutions.

### Data Integration Problems

**Low match rates between PTM and protein datasets (< 60%)**:
- **Cause**: Inconsistent protein identifiers between analyses
- **Solution**: Verify that both datasets used the same FASTA database and protein inference settings. Check for differences in database versions or contaminant databases.
- **Prevention**: Always use identical search parameters and databases for both total proteome and PTM analyses.

**Excessive missing values in integrated dataset**:
- **Cause**: Different detection sensitivities between total proteome and PTM experiments
- **Solution**: Adjust filtering criteria to balance data completeness with statistical power. Consider using less stringent identification thresholds for total proteome data.

### Statistical Analysis Issues

**No significant DPU sites despite significant PTM changes**:
- **Cause**: PTM changes may be proportional to protein changes, indicating no change in stoichiometry
- **Solution**: This is often a valid biological result. Verify by examining individual examples where protein and PTM changes are correlated.
- **Alternative interpretation**: Consider that your experimental perturbation primarily affects protein expression rather than signaling activity.

**High variability in DPU estimates**:
- **Cause**: Error propagation from both PTM and protein measurements can amplify uncertainty
- **Solution**: Focus on sites with high statistical confidence and large effect sizes. Consider using more stringent FDR thresholds.

### Computational Performance Issues

**Memory exhaustion during analysis**:
- **Cause**: Large datasets or inefficient memory usage
- **Solution**: Process data in chunks, reduce the number of fractions analyzed simultaneously, or use high-memory computing resources.
- **Optimization**: Remove low-quality features early in the analysis to reduce memory footprint.

**Long processing times for N-to-C plots**:
- **Cause**: Generating individual plots for hundreds of proteins is computationally intensive
- **Solution**: Limit plot generation to proteins of interest or use parallel processing when available.

### Biological Interpretation Challenges

**Conflicting results between DPA and DPU**:
- **Biological meaning**: This is often informative rather than problematic. Sites showing DPA but not DPU indicate protein-driven changes, while DPU-only sites indicate true signaling changes.
- **Validation**: Cross-reference results with known biology and literature to assess plausibility.

**Weak or absent sequence motifs**:
- **Cause**: Insufficient number of significant sites, mixed kinase activities, or non-canonical regulation
- **Solution**: Lower significance thresholds for motif analysis, analyze subsets of sites separately, or consider that the regulation may involve non-kinase mechanisms.

### Quality Control Recommendations

- **Always validate key findings**: Manually inspect high-confidence DPU sites to ensure biological plausibility
- **Check protein coverage**: Ensure that proteins of interest have adequate total proteome coverage for meaningful DPU analysis
- **Monitor technical factors**: Be aware of potential batch effects or systematic biases between PTM and total proteome experiments
- **Document analysis parameters**: Keep detailed records of all analysis parameters to ensure reproducibility


## Enhanced. Software Versions and Session Information

```{r sessioninfo}
# Display session information
cat("R Session Information:\n")
sessionInfo()

# Display package versions
cat("\nKey Package Versions:\n")
cat("- prolfquapp:", as.character(packageVersion("prolfquapp")), "\n")
cat("- prophosqua:", as.character(packageVersion("prophosqua")), "\n")
cat("- tidyverse:", as.character(packageVersion("tidyverse")), "\n")
```





