---
title: "Differential expression analysis of ptm-enriched and total proteome"
output:
  html_document:
    toc: true
    code_folding: show
date: "2025-07-07"
editor_options: 
  chunk_output_type: console

---

This vignette demonstrates how to perform **differential expression analysis (DEA)** on both total proteome and PTM-enriched proteome data using the `prolfquapp` package. The analysis compares protein expression changes between different experimental conditions, focusing on both overall protein abundance and post-translational modifications (PTMs).

## Overview

This workflow analyzes:
1. **Total proteome data** - Overall protein expression changes
2. **PTM-enriched data** - Post-translational modification changes (phosphorylation, etc.)
3. **Multi-site analysis** - Changes in specific modification sites
4. **Single-site analysis** - Individual modification site analysis

The example uses a factorial experimental design with genotype and timepoint factors.

```{r setup, include=FALSE}
wd <- here::here("inst", "PTM_example")
dir.create(wd, recursive = TRUE, showWarnings = FALSE)
knitr::opts_knit$set(root.dir = wd)
knitr::opts_chunk$set(
  warning = FALSE,
  message = FALSE,
  echo = TRUE
)
library(prolfquapp)
library(tidyverse)

```

# Data Preparation

## Downloading the example dataset

The first step is to download the example PTM dataset. This dataset contains both total proteome and PTM-enriched measurements from a factorial experiment.

```{r get_thedata}
zip_url  <- "https://gitlab.bfabric.org/wolski/ptm_example/-/archive/main/ptm_example-main.zip"
destfile <- "ptm_example-main.zip"

# Download and unzip
download.file(zip_url, destfile, mode = "wb")
unzip(destfile, exdir = ".")

```

## Setting up prolfquapp scripts

The `prolfquapp` package provides shell scripts for running differential expression analysis. This command copies these scripts to the current working directory.

```{bash get_scritps, results="hide"}
R --vanilla -e "library(prolfquapp); copy_shell_script(workdir = '.')"
```

## Creating sample annotation

Sample annotation is crucial for differential expression analysis. It defines the experimental design and groups samples according to their experimental conditions.

### Creating the initial dataset file

This command processes FragPipe output files to create a dataset annotation file that maps sample names to their experimental conditions.

```{bash create_dataset, results="hide"}
./prolfqua_dataset.sh --indir ptm_example-main/data_total/FP_22/ --dataset "ptm_example-main/data_total/dataset.tsv" --software prolfquapp.FP_TMT
```

### Adding experimental factors and contrasts

The sample names contain encoded information about the experimental design. This code:

1. **Parses sample names** to extract genotype and timepoint information
2. **Creates factorial contrasts** for statistical analysis
3. **Generates comparison groups** for differential expression testing

```{r create_contrasts}

annot <- readr::read_tsv("ptm_example-main/data_total/dataset.tsv")
knitr::kable(head(annot))
annot <- annot |> tidyr::separate("name", c("Genotype", "Timepoint", NA), sep = "_", remove = FALSE)
annot$group <- NULL
annot$subject <- NULL
annot$CONTROL <- NULL
annot2 <- prolfqua::annotation_add_contrasts(annot, "Genotype", "Timepoint" , decreasing = TRUE)$annot
knitr::kable(head(annot2))

write_tsv(annot2, "dataset_with_contrasts.tsv")

```

The file `dataset_with_contrasts.tsv` is the final dataset file that will be used for the differential expression analysis.

[Download the dataset with contrasts file](dataset_with_contrasts.tsv)



# Differential Expression Analysis

## Running DEA analysis of total proteome

This analysis examines changes in overall protein abundance between experimental conditions. The command:

- **`-i`**: Specifies input directory with FragPipe results
- **`-d`**: Uses the annotated dataset file
- **`-y`**: Applies configuration settings
- **`-w`**: Sets working directory name
- **`-s`**: Specifies software format (FragPipe TMT)

```{bash runDEAtotal, echo = TRUE, results="hide"}
./prolfqua_yaml.sh -y config.yaml
./prolfqua_dea.sh -i ptm_example-main/data_total/FP_22 -d dataset_with_contrasts.tsv -y config.yaml -w total_proteome -s  prolfquapp.FP_TMT
```

After running the differential expression analysis, the results are stored in a time-stamped directory. This code constructs the path to the results directory using the `prolfquapp::zipdir_name()` function, which follows the standard naming convention for DEA results.

```{r dir_total}
dir_total <- file.path(".", prolfquapp::zipdir_name("DEA", workunit_id = "total_proteome"))

```

The results of the total proteome analysis can be found in the [DEA report](`r dir_total`/index.html).


# Running DEA analysis of the enriched proteomes

PTM-enriched proteomes provide information about post-translational modifications. We analyze this data in two ways:

## Differential expression analysis for multi-site output

Multi-site analysis examines changes in modification patterns across multiple sites on the same protein. This is useful for understanding global modification changes.

```{bash multisite,eval=TRUE,results="hide"}
./prolfqua_dea.sh -i ptm_example-main/data_ptm/FP_22 -d dataset_with_contrasts.tsv -y config.yaml -w multisite_PTM -s  prolfquappPTMreaders.FP_multisite
```

```{r dirmultisite}
dir_multisite <- file.path(".", prolfquapp::zipdir_name("DEA", workunit_id = "multisite_PTM"))
```


The results of the multi-site analysis can be found in the [DEA report](`r dir_multisite`/index.html).

## Differential expression analysis for single-site output

Single-site analysis examines changes at individual modification sites. This provides site-specific information about which particular amino acids are modified under different conditions.

```{bash singlesite,eval=TRUE, results="hide"}
./prolfqua_dea.sh -i ptm_example-main/data_ptm/FP_22 -d dataset_with_contrasts.tsv -y config.yaml -w singlesite_PTM -s  prolfquappPTMreaders.FP_singlesite
```

```{r dirsinglesite}
dir_singlesite <- file.path(".", prolfquapp::zipdir_name("DEA", workunit_id = "singlesite_PTM"))
```

The results of the single-site analysis can be found in the [DEA report](`r dir_singlesite`/index.html).

## Analysis Output

After running these analyses, you will have:

1. **Total proteome results** - Protein-level differential expression
2. **Multi-site PTM results** - Modification pattern changes
3. **Single-site PTM results** - Individual modification site changes

Each analysis produces:
- Statistical tables with p-values and fold changes
- Visualization plots
- Quality control reports
- Excel files with comprehensive results

These results can be further integrated using the `prophosqua` package for combined analysis of total proteome and PTM data.

