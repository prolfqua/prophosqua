---
title: "Kinase Library: Kinase Activity Inference from Phosphoproteomics Data"
output:
  bookdown::html_document2:
    code_folding: hide
    toc: true
    toc_float: true
vignette: >
  %\VignetteIndexEntry{Kinase Library: Kinase Activity Inference from Phosphoproteomics Data}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  warning = FALSE
)
```

## Introduction

This vignette demonstrates kinase activity inference using the Kinase Library motif predictions. Unlike PTMsigDB (which uses curated kinase-substrate relationships), Kinase Library predicts kinase-substrate assignments based on position-specific scoring matrices (PSSMs) derived from peptide library screens.

We use the `term2gene.csv` file generated by the `scan_motifs_cli.py` script, which contains kinase-sequence assignments at the 90th percentile threshold.

**Approach:** GSEA (Gene Set Enrichment Analysis) using ranked phosphosite statistics.

We analyze both DPA (Differential PTM Abundance) and DPU (Differential PTM Usage) results.

## Load Data and Kinase Library Predictions

```{r load_data}
library(prophosqua)
library(clusterProfiler)
library(dplyr)
library(enrichplot)
library(purrr)

data("combined_test_diff_example", package = "prophosqua")
example_data <- combined_test_diff_example

data_info <- tibble(
  Property = c("Rows", "Columns", "Contrasts"),
  Value = c(nrow(example_data), ncol(example_data),
            paste(unique(example_data$contrast), collapse = ", "))
)
knitr::kable(data_info, caption = "Example Data")
```

```{r load_kinase_library}
zip_path <- system.file("extdata", "term2gene.csv.zip", package = "prophosqua")
term2gene <- read.csv(unz(zip_path, "term2gene.csv"))

kl_info <- tibble(
  Property = c("Total assignments", "Unique kinases", "Unique sequences"),
  Value = c(nrow(term2gene), n_distinct(term2gene$term), n_distinct(term2gene$gene))
)
knitr::kable(kl_info, caption = "Kinase Library Predictions")

# IMPORTANT: Kinase Library sequences have lowercase letters for phosphorylated residues
# (e.g., "PETITIRsGPPSPLP"). Convert to uppercase to match our data.
term2gene <- term2gene |>
  mutate(gene = toupper(gene))

# Keep as TERM2GENE format for clusterProfiler GSEA
term2gene_df <- term2gene |>
  select(term, gene)
```

## Kinase-Substrate Assignment Statistics

```{r assignment_stats}
our_sequences <- example_data |>
  pull(SequenceWindow) |>
  trimws() |>
  toupper() |>
  unique()
assigned_sequences <- unique(term2gene$gene)
overlap_seqs <- intersect(our_sequences, assigned_sequences)

assignment_stats <- tibble(
  Metric = c("Phosphosites in differential analysis",
             "Sites with kinase assignments",
             "Sites usable for GSEA",
             "Coverage (%)"),
  Value = c(length(our_sequences),
            length(assigned_sequences),
            length(overlap_seqs),
            round(100 * length(overlap_seqs) / length(our_sequences), 1))
)
knitr::kable(assignment_stats, caption = "Assignment Statistics (90th percentile threshold)")
```

```{r kinase_stats}
# Calculate kinase set sizes from term2gene
kinase_sizes <- term2gene_df |>
  count(term, name = "size")

kinase_overlap <- term2gene_df |>
  filter(gene %in% our_sequences) |>
  count(term, name = "overlap")

kinase_stats <- tibble(
  Metric = c("Number of kinases", "Mean substrates/kinase", "Median substrates/kinase",
             "Range (min-max)", "Mean substrates in our data",
             "Kinases with >= 15 substrates"),
  Value = c(nrow(kinase_sizes),
            round(mean(kinase_sizes$size)),
            median(kinase_sizes$size),
            paste(min(kinase_sizes$size), "-", max(kinase_sizes$size)),
            round(mean(kinase_overlap$overlap)),
            sum(kinase_overlap$overlap >= 15))
)
knitr::kable(kinase_stats, caption = "Kinase Set Size Distribution")
```

## DPA Analysis (Differential PTM Abundance)

DPA uses raw phosphosite fold changes, which include both true signaling changes and protein abundance effects.

### Prepare DPA Data

```{r prep_dpa}
# Prepare ranked lists using t-statistic
# Names must match sequences in term2gene

contrasts <- unique(example_data$contrast)

dpa_ranks <- contrasts |>
  set_names() |>
  map(function(ct) {
    example_data |>
      filter(contrast == ct) |>
      mutate(seq = toupper(trimws(SequenceWindow))) |>
      filter(!is.na(statistic.site)) |>
      distinct(seq, .keep_all = TRUE) |>
      arrange(desc(statistic.site)) |>
      (\(df) setNames(df$statistic.site, df$seq))()
  })

dpa_ranks_info <- tibble(
  Contrast = names(dpa_ranks),
  Sites = map_int(dpa_ranks, length)
)
knitr::kable(dpa_ranks_info, caption = "DPA Ranks Prepared")
```

### DPA: GSEA

```{r dpa_gsea, fig.width=12, fig.height=10}
dpa_gsea_results <- names(dpa_ranks) |>
  set_names() |>
  map(function(ct) {
    res <- GSEA(
      geneList = dpa_ranks[[ct]],
      TERM2GENE = term2gene_df,
      minGSSize = 15,
      maxGSSize = 5000,
      pvalueCutoff = 0.25,
      verbose = FALSE
    )
    if (nrow(res@result) == 0) {
      stop("No GSEA results for contrast: ", ct,
           ". Check minGSSize/maxGSSize parameters.")
    }
    res
  })

dpa_gsea_info <- tibble(
  Contrast = names(dpa_gsea_results),
  `Significant Kinases` = map_int(dpa_gsea_results, ~nrow(.x@result))
)
knitr::kable(dpa_gsea_info, caption = "DPA GSEA Results (FDR < 0.25)")
```

```{r dpa_gsea_plot, fig.width=14, fig.height=10}
merged_dpa <- merge_result(dpa_gsea_results)
dotplot(merged_dpa, showCategory = 15,
        title = "DPA GSEA - Kinase Library (FDR < 0.25)") +
  ggplot2::theme(axis.text.x = ggplot2::element_text(angle = 45, hjust = 1))
```

```{r dpa_gsea_individual, fig.width=14, fig.height=10}
dpa_plots <- names(dpa_gsea_results) |>
  map(function(ct) {
    dotplot(dpa_gsea_results[[ct]], showCategory = 15, title = ct) +
      ggplot2::theme(axis.text.y = ggplot2::element_text(size = 8))
  })
patchwork::wrap_plots(dpa_plots, ncol = 2)
```

## DPU Analysis (Differential PTM Usage)

DPU uses protein-normalized phosphosite fold changes, representing true stoichiometry changes independent of protein abundance.

### Prepare DPU Data

```{r prep_dpu}
dpu_ranks <- contrasts |>
  set_names() |>
  map(function(ct) {
    example_data |>
      filter(contrast == ct) |>
      mutate(seq = toupper(trimws(SequenceWindow))) |>
      filter(!is.na(tstatistic_I)) |>
      distinct(seq, .keep_all = TRUE) |>
      arrange(desc(tstatistic_I)) |>
      (\(df) setNames(df$tstatistic_I, df$seq))()
  })

dpu_ranks_info <- tibble(
  Contrast = names(dpu_ranks),
  Sites = map_int(dpu_ranks, length)
)
knitr::kable(dpu_ranks_info, caption = "DPU Ranks Prepared")
```

### DPU: GSEA

```{r dpu_gsea}
dpu_gsea_results <- names(dpu_ranks) |>
  set_names() |>
  map(function(ct) {
    res <- GSEA(
      geneList = dpu_ranks[[ct]],
      TERM2GENE = term2gene_df,
      minGSSize = 15,
      maxGSSize = 5000,
      pvalueCutoff = 0.25,
      verbose = FALSE
    )
    if (nrow(res@result) == 0) {
      stop("No GSEA results for contrast: ", ct,
           ". Check minGSSize/maxGSSize parameters.")
    }
    res
  })

dpu_gsea_info <- tibble(
  Contrast = names(dpu_gsea_results),
  `Significant Kinases` = map_int(dpu_gsea_results, ~nrow(.x@result))
)
knitr::kable(dpu_gsea_info, caption = "DPU GSEA Results (FDR < 0.25)")
```

```{r dpu_gsea_plot, fig.width=14, fig.height=10}
merged_dpu <- merge_result(dpu_gsea_results)
dotplot(merged_dpu, showCategory = 15,
        title = "DPU GSEA - Kinase Library (FDR < 0.25)") +
  ggplot2::theme(axis.text.x = ggplot2::element_text(angle = 45, hjust = 1))
```

```{r dpu_gsea_individual, fig.width=14, fig.height=10}
dpu_plots <- names(dpu_gsea_results) |>
  map(function(ct) {
    dotplot(dpu_gsea_results[[ct]], showCategory = 15, title = ct) +
      ggplot2::theme(axis.text.y = ggplot2::element_text(size = 8))
  })
patchwork::wrap_plots(dpu_plots, ncol = 2)
```

## Diagnostics

```{r diagnostic_pvalues}
pval_diag <- names(dpa_gsea_results) |>
  map_dfr(function(ct) {
    res <- dpa_gsea_results[[ct]]@result
    tibble(
      Contrast = ct,
      `Min p-value` = signif(min(res$pvalue), 3),
      `p < 0.05` = sum(res$pvalue < 0.05),
      `p < 0.01` = sum(res$pvalue < 0.01),
      Total = nrow(res)
    )
  })
knitr::kable(pval_diag, caption = "Raw p-value Distribution (DPA)")
```

```{r show_top_kinases}
if (length(dpa_gsea_results) > 0) {
  top_res <- dpa_gsea_results[[1]]@result |>
    as_tibble() |>
    arrange(pvalue) |>
    head(10) |>
    select(ID, enrichmentScore, NES, pvalue, p.adjust, setSize) |>
    mutate(
      enrichmentScore = round(enrichmentScore, 3),
      NES = round(NES, 3),
      pvalue = signif(pvalue, 3),
      p.adjust = signif(p.adjust, 3)
    )
  knitr::kable(top_res,
    caption = paste("Top 10 Kinases by P-value (DPA,",
                    names(dpa_gsea_results)[1], ")"))
}
```

### GSEA Enrichment Plot (Example)

```{r gsea_plots_dpa, fig.width=10, fig.height=6}
# Show single example for illustration (gseaplot2 objects don't combine well)
ct <- names(dpa_gsea_results)[1]
res <- dpa_gsea_results[[ct]]
top_kinase <- res@result |>
  as_tibble() |>
  arrange(pvalue) |>
  slice(1) |>
  pull(ID)

row <- res@result |>
  as_tibble() |>
  filter(ID == top_kinase)
nes_val <- round(row$NES, 2)
fdr <- signif(row$p.adjust, 2)

gseaplot2(res, geneSetID = top_kinase,
  title = paste0(ct, " - ", top_kinase, " (NES=", nes_val, ", FDR=", fdr, ")"))
```

## Session Info

```{r session_info}
sessionInfo()
```
