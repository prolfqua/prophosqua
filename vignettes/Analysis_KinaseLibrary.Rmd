---
title: "Kinase Library: Kinase Activity Inference from Phosphoproteomics Data"
output:
  bookdown::html_document2:
    code_folding: hide
    toc: true
    toc_float: true
vignette: >
  %\VignetteIndexEntry{Kinase Library: Kinase Activity Inference from Phosphoproteomics Data}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  warning = FALSE,
  fig.width = 12,
  fig.height = 10
)
```

## Introduction

This vignette demonstrates kinase activity inference using the **Kinase Library**
motif predictions. Unlike PTMsigDB (which uses curated kinase-substrate relationships),
Kinase Library predicts kinase-substrate assignments based on position-specific
scoring matrices (PSSMs) derived from peptide library screens.

We use the `term2gene.csv` file which contains kinase-sequence assignments at
the 90th percentile threshold.

**Approach:** GSEA (Gene Set Enrichment Analysis) using ranked phosphosite statistics.

We analyze both DPA (Differential PTM Abundance) and DPU (Differential PTM Usage) results.

## Load Data and Kinase Library Predictions

```{r load-packages}
library(clusterProfiler)
library(dplyr)
library(tidyr)
library(readxl)
library(ggplot2)
library(enrichplot)
library(purrr)
library(forcats)
library(writexl)
library(patchwork)
library(DT)
library(prophosqua)
```

```{r load-data}
# Load example data
data("combined_test_diff_example", package = "prophosqua")
data <- combined_test_diff_example

data_info <- tibble(
  Property = c("Rows", "Columns", "Contrasts"),
  Value = c(nrow(data), ncol(data),
            paste(unique(data$contrast), collapse = ", "))
)
knitr::kable(data_info, caption = "Differential Analysis Data")
```

```{r load-kinase-library}
# Load term2gene from bundled zip file
zip_path <- system.file("extdata", "term2gene.csv.zip", package = "prophosqua")
term2gene <- read.csv(unz(zip_path, "term2gene.csv"))

kl_info <- tibble(
  Property = c("Total assignments", "Unique kinases", "Unique sequences"),
  Value = c(nrow(term2gene), n_distinct(term2gene$term), n_distinct(term2gene$gene))
)
knitr::kable(kl_info, caption = "Kinase Library Predictions")

# IMPORTANT: Kinase Library sequences have lowercase letters for phosphorylated residues
# (e.g., "PETITIRsGPPSPLP"). Convert to uppercase to match our data.
term2gene <- term2gene |>
  mutate(gene = toupper(gene))

# Keep as TERM2GENE format for clusterProfiler GSEA
term2gene_df <- term2gene |>
  select(term, gene)
```

## Kinase-Substrate Assignment Statistics

```{r assignment-stats}
our_sequences <- data |>
  pull(SequenceWindow) |>
  trimws() |>
  toupper() |>
  unique()
assigned_sequences <- unique(term2gene$gene)
overlap_seqs <- intersect(our_sequences, assigned_sequences)

assignment_stats <- tibble(
  Metric = c("Phosphosites in differential analysis",
             "Sites with kinase assignments",
             "Sites usable for GSEA",
             "Coverage (%)"),
  Value = c(length(our_sequences),
            length(assigned_sequences),
            length(overlap_seqs),
            round(100 * length(overlap_seqs) / length(our_sequences), 1))
)
knitr::kable(assignment_stats, caption = "Assignment Statistics (90th percentile threshold)")
```

```{r kinase-stats}
# Calculate kinase set sizes from term2gene
kinase_sizes <- term2gene_df |>
  count(term, name = "size")

kinase_overlap <- term2gene_df |>
  filter(gene %in% our_sequences) |>
  count(term, name = "overlap")

kinase_stats <- tibble(
  Metric = c("Number of kinases", "Mean substrates/kinase", "Median substrates/kinase",
             "Range (min-max)", "Mean substrates in our data",
             "Kinases with >= 15 substrates"),
  Value = c(nrow(kinase_sizes),
            round(mean(kinase_sizes$size)),
            median(kinase_sizes$size),
            paste(min(kinase_sizes$size), "-", max(kinase_sizes$size)),
            round(mean(kinase_overlap$overlap, na.rm = TRUE)),
            sum(kinase_overlap$overlap >= 15, na.rm = TRUE))
)
knitr::kable(kinase_stats, caption = "Kinase Set Size Distribution")
```

## DPA Analysis (Differential PTM Abundance)

DPA uses raw phosphosite fold changes, which include both true signaling changes
and protein abundance effects.

### Prepare DPA Ranked Lists

```{r prepare-dpa-ranks}
# Prepare ranked lists using prophosqua function
dpa_ranks <- prepare_gsea_ranks(
  data,
  stat_col = "statistic.site",
  seq_col = "SequenceWindow",
  contrast_col = "contrast"
)

dpa_ranks_info <- tibble(
  Contrast = names(dpa_ranks),
  Sites = map_int(dpa_ranks, length)
)
knitr::kable(dpa_ranks_info, caption = "DPA Ranks Prepared")
```

### DPA: GSEA Analysis

```{r run-dpa-gsea}
dpa_gsea_results <- names(dpa_ranks) |>
  set_names() |>
  map(function(ct) {
    GSEA(
      geneList = dpa_ranks[[ct]],
      TERM2GENE = term2gene_df,
      minGSSize = 15,
      maxGSSize = 5000,
      pvalueCutoff = 0.25,
      verbose = FALSE
    )
  })

dpa_gsea_info <- tibble(
  Contrast = names(dpa_gsea_results),
  `Significant Kinases (FDR < 0.25)` = map_int(dpa_gsea_results, ~sum(.x@result$p.adjust < 0.25, na.rm = TRUE))
)
knitr::kable(dpa_gsea_info, caption = "DPA GSEA Results Summary")
```

### DPA Results by Contrast {.tabset .tabset-pills}

```{r dpa-contrast-plots, results='asis', fig.height=8}
# Extract all results into data frame using shared function
all_clean_dpa <- extract_gsea_results(dpa_gsea_results) |>
  mutate(kinase = ID)

for (ctr in unique(all_clean_dpa$contrast)) {
  cat("\n\n#### ", ctr, "\n\n")

  ctr_data <- all_clean_dpa |> filter(contrast == ctr)
  n_sig <- sum(ctr_data$p.adjust < 0.1, na.rm = TRUE)
  cat("**Significant kinases (FDR < 0.1):** ", n_sig, "\n\n")

  # Using shared dotplot function
  p <- plot_enrichment_dotplot(
    ctr_data,
    item_col = "kinase",
    fdr_col = "p.adjust",
    title = paste0("DPA - ", ctr),
    subtitle = "Top 30 kinases by FDR"
  )
  print(p)
  cat("\n\n")
}
```

### DPA clusterProfiler Dotplots

```{r dpa-merged-dotplot, fig.width=14, fig.height=10}
merged_dpa <- merge_result(dpa_gsea_results)
dotplot(merged_dpa, showCategory = 15,
        title = "DPA GSEA - Kinase Library (FDR < 0.25)") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

```{r dpa-individual-dotplots, fig.width=14, fig.height=10}
dpa_plots <- names(dpa_gsea_results) |>
  map(function(ct) {
    res <- dpa_gsea_results[[ct]]@result
    # Skip if no results
    if (nrow(res) == 0 || sum(!is.na(res$NES)) == 0) {
      return(ggplot() +
        annotate("text", x = 0.5, y = 0.5, label = paste(ct, "\nNo significant kinases")) +
        theme_void() + ggtitle(ct))
    }
    dotplot(dpa_gsea_results[[ct]], showCategory = 15, title = ct) +
      theme(axis.text.y = element_text(size = 8))
  })
wrap_plots(dpa_plots, ncol = 2)
```

### DPA NES Heatmap

```{r dpa-nes-heatmap, fig.width=12, fig.height=10}
# Using shared heatmap function
plot_enrichment_heatmap(
  all_clean_dpa,
  item_col = "ID",
  fdr_col = "p.adjust",
  fdr_filter = 0.25,
  n_top = 30,
  title = "DPA - Top Kinases by NES"
)
```

## DPU Analysis (Differential PTM Usage)

DPU uses protein-normalized phosphosite fold changes, representing true
stoichiometry changes independent of protein abundance.

### Prepare DPU Ranked Lists

```{r prepare-dpu-ranks}
dpu_ranks <- prepare_gsea_ranks(
  data,
  stat_col = "tstatistic_I",
  seq_col = "SequenceWindow",
  contrast_col = "contrast"
)

dpu_ranks_info <- tibble(
  Contrast = names(dpu_ranks),
  Sites = map_int(dpu_ranks, length)
)
knitr::kable(dpu_ranks_info, caption = "DPU Ranks Prepared")
```

### DPU: GSEA Analysis

```{r run-dpu-gsea}
dpu_gsea_results <- names(dpu_ranks) |>
  set_names() |>
  map(function(ct) {
    GSEA(
      geneList = dpu_ranks[[ct]],
      TERM2GENE = term2gene_df,
      minGSSize = 15,
      maxGSSize = 5000,
      pvalueCutoff = 0.25,
      verbose = FALSE
    )
  })

dpu_gsea_info <- tibble(
  Contrast = names(dpu_gsea_results),
  `Significant Kinases (FDR < 0.25)` = map_int(dpu_gsea_results, ~sum(.x@result$p.adjust < 0.25, na.rm = TRUE))
)
knitr::kable(dpu_gsea_info, caption = "DPU GSEA Results Summary")
```

### DPU Results by Contrast {.tabset .tabset-pills}

```{r dpu-contrast-plots, results='asis', fig.height=8}
all_clean_dpu <- extract_gsea_results(dpu_gsea_results) |>
  mutate(kinase = ID)

for (ctr in unique(all_clean_dpu$contrast)) {
  cat("\n\n#### ", ctr, "\n\n")

  ctr_data <- all_clean_dpu |> filter(contrast == ctr)
  n_sig <- sum(ctr_data$p.adjust < 0.1, na.rm = TRUE)
  cat("**Significant kinases (FDR < 0.1):** ", n_sig, "\n\n")

  p <- plot_enrichment_dotplot(
    ctr_data,
    item_col = "kinase",
    fdr_col = "p.adjust",
    title = paste0("DPU - ", ctr),
    subtitle = "Top 30 kinases by FDR"
  )
  print(p)
  cat("\n\n")
}
```

### DPU clusterProfiler Dotplots

```{r dpu-merged-dotplot, fig.width=14, fig.height=10}
merged_dpu <- merge_result(dpu_gsea_results)
dotplot(merged_dpu, showCategory = 15,
        title = "DPU GSEA - Kinase Library (FDR < 0.25)") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

```{r dpu-individual-dotplots, fig.width=14, fig.height=10}
dpu_plots <- names(dpu_gsea_results) |>
  map(function(ct) {
    res <- dpu_gsea_results[[ct]]@result
    if (nrow(res) == 0 || sum(!is.na(res$NES)) == 0) {
      return(ggplot() +
        annotate("text", x = 0.5, y = 0.5, label = paste(ct, "\nNo significant kinases")) +
        theme_void() + ggtitle(ct))
    }
    dotplot(dpu_gsea_results[[ct]], showCategory = 15, title = ct) +
      theme(axis.text.y = element_text(size = 8))
  })
wrap_plots(dpu_plots, ncol = 2)
```

### DPU NES Heatmap

```{r dpu-nes-heatmap, fig.width=12, fig.height=10}
plot_enrichment_heatmap(
  all_clean_dpu,
  item_col = "ID",
  fdr_col = "p.adjust",
  fdr_filter = 0.25,
  n_top = 30,
  title = "DPU - Top Kinases by NES"
)
```

## Volcano Plots

```{r dpa-volcano-plot, fig.width=12, fig.height=8}
# Using shared volcano function
plot_enrichment_volcano(
  all_clean_dpa,
  item_col = "ID",
  fdr_col = "p.adjust",
  title = "DPA - GSEA Volcano Plots"
)
```

```{r dpu-volcano-plot, fig.width=12, fig.height=8}
plot_enrichment_volcano(
  all_clean_dpu,
  item_col = "ID",
  fdr_col = "p.adjust",
  title = "DPU - GSEA Volcano Plots"
)
```

## Diagnostics

```{r diagnostic-pvalues}
pval_diag <- names(dpa_gsea_results) |>
  map_dfr(function(ct) {
    res <- dpa_gsea_results[[ct]]@result
    tibble(
      Contrast = ct,
      `Min p-value` = signif(min(res$pvalue, na.rm = TRUE), 3),
      `p < 0.05` = sum(res$pvalue < 0.05, na.rm = TRUE),
      `p < 0.01` = sum(res$pvalue < 0.01, na.rm = TRUE),
      Total = nrow(res)
    )
  })
knitr::kable(pval_diag, caption = "Raw p-value Distribution (DPA)")
```

```{r show-top-kinases}
if (length(dpa_gsea_results) > 0) {
  top_res <- dpa_gsea_results[[1]]@result |>
    as_tibble() |>
    arrange(pvalue) |>
    head(10) |>
    select(ID, enrichmentScore, NES, pvalue, p.adjust, setSize) |>
    mutate(
      enrichmentScore = round(enrichmentScore, 3),
      NES = round(NES, 3),
      pvalue = signif(pvalue, 3),
      p.adjust = signif(p.adjust, 3)
    )
  knitr::kable(top_res,
    caption = paste("Top 10 Kinases by P-value (DPA,",
                    names(dpa_gsea_results)[1], ")"))
}
```

## GSEA Enrichment Plot (Example)

```{r gsea-example-plot, fig.width=10, fig.height=6}
# Show single example for illustration (gseaplot2 objects don't combine well)
ct <- names(dpa_gsea_results)[1]
res <- dpa_gsea_results[[ct]]

if (nrow(res@result) > 0) {
  top_kinase <- res@result |>
    as_tibble() |>
    arrange(pvalue) |>
    slice(1) |>
    pull(ID)

  row <- res@result |>
    as_tibble() |>
    filter(ID == top_kinase)
  nes_val <- round(row$NES, 2)
  fdr <- signif(row$p.adjust, 2)

  gseaplot2(res, geneSetID = top_kinase,
    title = paste0(ct, " - ", top_kinase, " (NES=", nes_val, ", FDR=", fdr, ")"))
}
```

## All Results

```{r allResults}
# All kinases across all contrasts (DPA)
all_results_dt <- names(dpa_gsea_results) |>
  map_dfr(function(ct) {
    dpa_gsea_results[[ct]]@result |>
      as_tibble() |>
      mutate(contrast = ct) |>
      select(contrast, kinase = ID, NES, pvalue, FDR = p.adjust, setSize)
  }) |>
  arrange(contrast, FDR) |>
  mutate(across(where(is.numeric), ~round(.x, 4)))

DT::datatable(all_results_dt,
  filter = "top",
  extensions = 'Buttons',
  options = list(pageLength = 15, scrollX = TRUE,
                 dom = 'Bfrtip', buttons = c('copy', 'csv', 'excel')),
  caption = "All kinases across all contrasts (DPA)")
```

## Session Info

```{r session-info}
sessionInfo()
```
