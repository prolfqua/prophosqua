---
title: "PTM Analysis - N-to-C Plots"
subtitle: "`r params$analysis_type` Analysis"
author: "FGCZ"
date: "`r format(Sys.time(), '%d %B, %Y')`"
params:
  xlsx_file: NULL
  sheet: "DPA"
  analysis_type: "dpa"
  output_dir: NULL
  fdr: 0.05
  fc: 0.6
  max_fig: 10000
output:
  bookdown::html_document2:
    toc: true
    toc_float: true
    code_folding: hide
    self_contained: true
  pdf_document:
    toc: true
vignette: >
  %\VignetteIndexEntry{N-to-C Plots}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  warning = FALSE,
  fig.width = 10,
  fig.height = 6,
  dpi = 300
)

suppressPackageStartupMessages({
  library(prophosqua)
  library(dplyr)
  library(readxl)
  library(patchwork)
})

# Detect pipeline vs vignette mode
pipeline_mode <- !is.null(params$xlsx_file)

# Load shared utilities if in pipeline mode
if (pipeline_mode && file.exists("src/feature_preparation.R")) {
  source("src/feature_preparation.R")
}

max_fig <- params$max_fig
```

# Introduction

This document generates N-to-C plots for **`r toupper(params$analysis_type)`** analysis.

```{r analysisDescription, results='asis'}
desc <- switch(params$analysis_type,
  "dpa" = "**DPA (Differential PTM Abundance)**: Raw PTM signal changes without protein abundance correction. Shows both site-level and protein-level fold changes.",
  "dpu" = "**DPU (Differential PTM Usage)**: Protein-normalized PTM changes (model-first approach). Reflects genuine modification stoichiometry changes.",
  "cf" = "**CF (CorrectFirst)**: Alternative protein-correction approach where abundances are normalized before statistical modeling."
)
cat(desc)
```

# Data Loading

```{r loadData}
if (pipeline_mode) {
  message("Loading data from: ", params$xlsx_file, " (sheet: ", params$sheet, ")")
  data <- readxl::read_xlsx(params$xlsx_file, sheet = params$sheet)
  output_dir <- if (!is.null(params$output_dir)) params$output_dir else dirname(params$xlsx_file)
} else {
  # Vignette mode: use example data
  data("combined_test_diff_example", package = "prophosqua")
  data <- combined_test_diff_example
  output_dir <- tempdir()
  message("Using example data from prophosqua package")
}

data_info <- tibble(
  Property = c("Mode", "Sheet", "Analysis Type", "Rows", "Contrasts"),
  Value = c(
    if (pipeline_mode) basename(params$xlsx_file) else "Example data",
    params$sheet, toupper(params$analysis_type),
    nrow(data), paste(unique(data$contrast), collapse = ", ")
  )
)
knitr::kable(data_info, caption = "Data Summary")
```

```{r prepareData}
# Prepare data for plotting using shared function
plot_data <- prepare_ntoc_data(data, params$analysis_type)

all_contrasts <- unique(plot_data$contrast)
cat("Found", length(all_contrasts), "contrasts:", paste(all_contrasts, collapse = ", "), "\n")
```

# Generate N-to-C Plots

**Filtering criteria:** Proteins are included if they contain at least one PTM site with FDR < `r params$fdr` and |log2 fold change| > `r params$fc`.

```{r generatePlots, results='hide'}
if (params$analysis_type == "dpa") {
  # DPA: Use expression plotting (shows protein + site)
  plot_result <- n_to_c_expression_multicontrast(
    plot_data,
    FDR_threshold = params$fdr,
    fc_threshold = params$fc,
    max_plots = max_fig
  )
} else {
  # DPU/CF: Use usage plotting (shows site only)
  plot_result <- n_to_c_usage_multicontrast(
    plot_data,
    FDR_threshold = params$fdr,
    fc_threshold = params$fc,
    max_plots = max_fig
  )
}

n_plots <- nrow(plot_result)
stopifnot("No significant sites found. Adjust fdr/log2fc thresholds in config." = n_plots > 0)
cat("Generated", n_plots, "multi-contrast plots\n")
```

## Example Plots

Showing example plots in the HTML report: one protein WITH protein-level data and one WITHOUT (if available). `r if(pipeline_mode) paste0("All ", n_plots, " plots are exported to PDF.")`

```{r displayExamples, fig.width=12, fig.height=10, results='asis'}
if (n_plots > 0 && params$analysis_type == "dpa") {
  # For DPA: show examples of proteins with and without protein-level data
  # Find proteins with matched protein data (has diff.protein)
  matched_proteins <- plot_data |>
    dplyr::filter(!is.na(diff.protein)) |>
    dplyr::pull(protein_Id) |>
    unique()

  # Find proteins without matched protein data
  unmatched_proteins <- plot_data |>
    dplyr::filter(is.na(diff.protein)) |>
    dplyr::pull(protein_Id) |>
    unique()

  # Get indices in plot_result for each type
  matched_idx <- which(plot_result$protein_Id %in% matched_proteins)
  unmatched_idx <- which(plot_result$protein_Id %in% unmatched_proteins)

  examples_to_show <- c()

  # Add one matched protein if available
  if (length(matched_idx) > 0) {
    examples_to_show <- c(examples_to_show, matched_idx[1])
  }

  # Add one unmatched protein if available
  if (length(unmatched_idx) > 0) {
    examples_to_show <- c(examples_to_show, unmatched_idx[1])
  }

  # Fallback: if no examples found, use first 2
  if (length(examples_to_show) == 0) {
    examples_to_show <- seq_len(min(2, n_plots))
  }

  cat("\n\n**Note:** ", length(matched_idx), " proteins have protein-level data, ",
      length(unmatched_idx), " proteins do not.\n\n", sep = "")

  for (i in examples_to_show) {
    has_protein <- plot_result$protein_Id[i] %in% matched_proteins
    label <- if (has_protein) "(with protein data)" else "(NO protein data)"
    cat("\n\n### ", plot_result$protein_Id[i], " ", label, "\n\n", sep = "")
    print(plot_result$plot[[i]])
    cat("\n\n")
  }
} else if (n_plots > 0) {
  # DPU/CF: just show first 2
  n_examples <- min(2, n_plots)
  for (i in seq_len(n_examples)) {
    cat("\n\n### ", plot_result$protein_Id[i], "\n\n")
    print(plot_result$plot[[i]])
    cat("\n\n")
  }
} else {
  cat("No significant proteins found with the current filtering criteria.\n")
}
```

# Export Plots

```{r exportPdf, results='hide', eval=pipeline_mode}
# Use explicit output_dir if provided, otherwise use xlsx directory
pdf_dir <- output_dir

if (!dir.exists(pdf_dir)) {
  dir.create(pdf_dir, recursive = TRUE)
}

# Determine output filename based on analysis type
pdf_name <- switch(params$analysis_type,
  "dpa" = "Site_differential_Expression_MultiContrast.pdf",
  "dpu" = "Site_differential_UsageChange_MultiContrast.pdf",
  "cf"  = "Site_differential_CorrectFirst_MultiContrast.pdf"
)

pdf_path <- file.path(pdf_dir, pdf_name)

if (n_plots > 0) {
  pdf(pdf_path, width = 14, height = 10)
  for (i in seq_len(n_plots)) {
    print(plot_result$plot[[i]])
  }
  dev.off()
  cat("Exported", n_plots, "plots to:", pdf_path, "\n")
} else {
  cat("No plots to export.\n")
}
```

```{r exportPdfVignette, results='hide', eval=!pipeline_mode}
message("Vignette mode: PDF export skipped.")
pdf_path <- NULL
```

# Results Summary

```{r summary}
summary_info <- tibble(
  Metric = c("Analysis Type", "Total Proteins", "Plots Generated",
             "Shown in HTML", "FDR Threshold", "FC Threshold"),
  Value = c(toupper(params$analysis_type), n_distinct(plot_data$protein_Id),
            n_plots, min(2, n_plots), params$fdr, params$fc)
)
knitr::kable(summary_info, caption = "Analysis Summary")

if (pipeline_mode && n_plots > 0) {
  cat("\nPDF exported to:", pdf_path, "\n")
}
```

# Session Info

```{r sessionInfo}
sessionInfo()
```
