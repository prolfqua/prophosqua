# Snakefile for rendering prophosqua vignettes
#
# Usage:
#   snakemake -j1              # Build all outputs
#   snakemake -j1 help         # Show this help
#   snakemake -j1 clean        # Remove generated files
#   snakemake -j1 <target>     # Build specific target
#
# Targets:
#   all                        - Build all vignettes (default)
#   mea                        - Build 4 kinase/motif enrichment vignettes
#   render_supplementary       - Render Supplementary_Material_v3.docx
#   renumber_references        - Renumber Notes/Figures/Tables in DOCX
#   render_ptmsea              - Render Analysis_PTMSEA.html
#   render_motif               - Render Analysis_Motif_Enrichment.html
#   render_kl                  - Render Analysis_KinaseLibrary.html
#   render_vis                 - Render Vis_MEA.html
#   kl                         - Run kinase-library + render KL/Vis vignettes
#   install_package            - Reinstall prophosqua package
#
# Notes:
#   - Package is automatically reinstalled when R/*.R or DESCRIPTION changes
#   - Use 'rm .package_installed' to force package reinstall

import glob

# Get all R source files to track for package reinstallation
R_FILES = glob.glob("../R/*.R")
DESCRIPTION = "../DESCRIPTION"
RDS_FILE = "../data/combined_test_diff_example.rds"
CONTRASTS = ["KO_vs_WT", "KO_vs_WT_at_Early", "KO_vs_WT_at_Late", "KO_vs_WT_at_Uninfect"]
KL_REPO = "git+https://github.com/wolski/kinase-library"

rule help:
    """Show available targets and usage"""
    run:
        print("""
Snakefile for rendering prophosqua vignettes

Usage:
  snakemake -j1              Build all outputs
  snakemake -j1 help         Show this help
  snakemake -j1 clean        Remove generated files
  snakemake -j1 <target>     Build specific target

Targets:
  all                        Build all vignettes (default)
  mea                        Build 4 kinase/motif enrichment vignettes
  render_supplementary       Render Supplementary_Material_v3.docx
  renumber_references        Renumber Notes/Figures/Tables in DOCX
  render_ptmsea              Render Analysis_PTMSEA.html
  render_motif               Render Analysis_Motif_Enrichment.html
  render_kl                  Render Analysis_KinaseLibrary.html
  render_vis                 Render Vis_MEA.html
  kl                         Run kinase-library + render KL/Vis vignettes
  install_package            Reinstall prophosqua package

Notes:
  - Package is automatically reinstalled when R/*.R or DESCRIPTION changes
  - Use 'rm .package_installed' to force package reinstall
        """)

rule all:
    input:
        "Supplementary_Material_v3_renumbered.docx",
        "Analysis_PTMSEA.html"

rule mea:
    """Build all 4 kinase/motif enrichment vignettes"""
    input:
        "Analysis_PTMSEA.html",
        "Analysis_Motif_Enrichment.html",
        "Analysis_KinaseLibrary.html",
        "Vis_MEA.html"

rule clean:
    """Remove generated files"""
    shell:
        """
        rm -f .package_installed
        rm -f Supplementary_Material_v3.docx Supplementary_Material_v3_renumbered.docx
        rm -f Analysis_PTMSEA.html Analysis_Motif_Enrichment.html
        rm -f Analysis_KinaseLibrary.html Vis_MEA.html
        rm -f *.knit.md *.utf8.md
        rm -f seqwindows.tsv *.rnk term2gene.csv mea_*.csv
        """

rule install_package:
    input:
        r_files=R_FILES,
        description=DESCRIPTION
    output:
        touch(".package_installed")
    shell:
        """
        Rscript -e "devtools::install('..')"
        """

rule render_supplementary:
    input:
        rmd="Supplementary_Material_v3.Rmd",
        pkg=".package_installed"
    output:
        "Supplementary_Material_v3.docx"
    shell:
        """
        Rscript -e "rmarkdown::render('{input.rmd}', output_format = 'bookdown::word_document2', clean = FALSE)"
        """

rule renumber_references:
    """Renumber Note 4.X -> X, Figure 5.X -> X, Table 5.X -> X in DOCX"""
    input:
        docx="Supplementary_Material_v3.docx",
        script="rename_notes.py"
    output:
        "Supplementary_Material_v3_renumbered.docx"
    shell:
        """
        uv run --with python-docx python {input.script}
        """

rule render_ptmsea:
    input:
        rmd="Analysis_PTMSEA.Rmd",
        pkg=".package_installed"
    output:
        "Analysis_PTMSEA.html"
    shell:
        """
        Rscript -e "rmarkdown::render('{input.rmd}', clean = FALSE)"
        """

rule render_motif:
    input:
        rmd="Analysis_Motif_Enrichment.Rmd",
        pkg=".package_installed"
    output:
        "Analysis_Motif_Enrichment.html"
    shell:
        """
        Rscript -e "rmarkdown::render('{input.rmd}', clean = FALSE)"
        """

rule render_kl:
    input:
        rmd="Analysis_KinaseLibrary.Rmd",
        pkg=".package_installed",
        term2gene="term2gene.csv"
    output:
        "Analysis_KinaseLibrary.html"
    shell:
        """
        Rscript -e "rmarkdown::render('{input.rmd}', clean = FALSE)"
        """

rule render_vis:
    input:
        rmd="Vis_MEA.Rmd",
        pkg=".package_installed",
        mea=expand("mea_{contrast}.csv", contrast=CONTRASTS)
    output:
        "Vis_MEA.html"
    shell:
        """
        Rscript -e "rmarkdown::render('{input.rmd}', clean = FALSE)"
        """

# Kinase-library integration rules

rule kl:
    """Run kinase-library analysis + render KL/Vis vignettes"""
    input:
        "term2gene.csv",
        expand("mea_{contrast}.csv", contrast=CONTRASTS),
        "Analysis_KinaseLibrary.html",
        "Vis_MEA.html"

rule extract_seqs:
    """Extract unique sequences from RDS for motif scanning"""
    input:
        RDS_FILE
    output:
        "seqwindows.tsv"
    shell:
        """
        Rscript -e "
        data <- readRDS('{input}')
        seqs <- unique(data[, 'SequenceWindow', drop=FALSE])
        write.table(seqs, '{output}', sep='\t', row.names=FALSE, quote=FALSE)
        "
        """

rule extract_rnk:
    """Extract ranked sequences per contrast for MEA"""
    input:
        RDS_FILE
    output:
        expand("{contrast}.rnk", contrast=CONTRASTS)
    shell:
        """
        Rscript -e "
        data <- readRDS('{input}')
        for (ct in unique(data\\$contrast)) {{
            sub <- data[data\\$contrast == ct, c('SequenceWindow', 'statistic.site')]
            sub <- sub[!is.na(sub\\$statistic.site), ]
            fname <- paste0(ct, '.rnk')
            write.table(sub, fname, sep='\t', row.names=FALSE, quote=FALSE)
        }}
        "
        """

rule scan_motifs:
    """Run kinase-library scan-motifs to generate term2gene.csv"""
    input:
        "seqwindows.tsv"
    output:
        "term2gene.csv"
    params:
        repo=KL_REPO
    shell:
        """
        uv tool run --from {params.repo} scan-motifs {input} \
            --seq-col SequenceWindow \
            --output {output} \
            --kin-type ser_thr \
            --threshold 95 \
            --term2gene
        """

rule run_mea:
    """Run kinase-library MEA for a single contrast"""
    input:
        "{contrast}.rnk"
    output:
        "mea_{contrast}.csv"
    threads: 4
    params:
        repo=KL_REPO
    shell:
        """
        uv tool run --from {params.repo} run-mea {input} \
            --seq-col SequenceWindow \
            --rank-col statistic.site \
            --output {output} \
            --kin-type ser_thr \
            --threshold 95 \
            --permutations 1000 \
            --threads {threads}
        """
