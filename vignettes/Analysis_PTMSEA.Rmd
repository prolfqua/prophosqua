---
title: "PTM-SEA: Kinase Activity Inference from Phosphoproteomics Data"
output:
  bookdown::html_document2:
    code_folding: hide
    toc: true
    toc_float: true
vignette: >
  %\VignetteIndexEntry{PTM-SEA: Kinase Activity Inference from Phosphoproteomics Data}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  warning = FALSE
)
```

## Introduction

PTM-SEA (Post-Translational Modification Signature Enrichment Analysis) uses curated phosphosite signatures from PTMsigDB to infer kinase activities from phosphoproteomics data. This vignette demonstrates three approaches:

1. **GSEA without direction** - ignores ;u/;d suffixes in PTMsigDB
2. **GSEA with direction** - splits pathways into _up and _down sets
3. **ORA with direction** - over-representation analysis on significant sites

We analyze both DPA (Differential PTM Abundance) and DPU (Differential PTM Usage) results.

## Load Data and PTMsigDB

```{r load_data}
library(prophosqua)
library(clusterProfiler)
library(dplyr)
library(enrichplot)
library(fgsea)
library(purrr)

# Load example data
example_path <- here::here("data", "combined_test_diff_example.rds")
example_data <- readRDS(example_path)

data_info <- tibble(
  Property = c("Rows", "Columns", "Contrasts"),
  Value = c(nrow(example_data), ncol(example_data),
            paste(unique(example_data$contrast), collapse = ", "))
)
knitr::kable(data_info, caption = "Example Data")
```

```{r download_ptmsigdb}
# Download PTMsigDB signatures
gmt_path <- download_ptmsigdb(species = "mouse", output_dir = tempdir())
pathways_raw <- fgsea::gmtPathways(gmt_path)

# Trim pathways to 11-mer (default) to increase overlap with our data
pathways <- trim_ptmsigdb_pathways(pathways_raw, trim_to = "11")
```

## Overlap Statistics

Understanding the overlap between our data and PTMsigDB is crucial for interpreting results.

```{r overlap_stats}
# Our data: unique flanking sequences (trimmed to 11-mer to match pathways)
our_sequences <- example_data |>
  pull(SequenceWindow) |>
  trimws() |>
  toupper() |>
  unique()
our_sequences_trimmed <- our_sequences |>
  map_chr(~prophosqua:::trim_flanking_seq(.x, trim_to = 11L))
our_site_ids <- paste0(our_sequences_trimmed, "-p")
n_our_sites <- n_distinct(our_site_ids)

# PTMsigDB: unique site IDs (strip ;u/;d for comparison)
ptmsigdb_ids_raw <- pathways |>
  unlist() |>
  unique()
ptmsigdb_ids_stripped <- ptmsigdb_ids_raw |>
  gsub(";[ud]$", "", x = _) |>
  unique()
n_ptmsigdb_sites <- length(ptmsigdb_ids_stripped)

# Overlap
overlap_ids <- intersect(unique(our_site_ids), ptmsigdb_ids_stripped)
n_overlap <- length(overlap_ids)

overlap_stats <- tibble(
  Metric = c("Our data (unique sequences)", "PTMsigDB (unique site IDs)", "Overlap",
             "% of our sites", "% of PTMsigDB sites"),
  Value = c(n_our_sites, n_ptmsigdb_sites, n_overlap,
            round(100 * n_overlap / n_our_sites, 2),
            round(100 * n_overlap / n_ptmsigdb_sites, 2))
)
knitr::kable(overlap_stats, caption = "Overlap Statistics (11-mer)")
```

The low overlap is expected because:

1. PTMsigDB contains curated kinase-substrate relationships (~1,700 unique sites)
2. Our phosphoproteomics data measures ~20,000+ sites
3. Most measured sites have no known kinase annotation

## DPA Analysis (Differential PTM Abundance)

DPA uses raw phosphosite fold changes, which include both true signaling changes and protein abundance effects.

### Prepare DPA Data

```{r prep_dpa}
# Use t-statistic for ranking
prep_dpa <- ptmsea_data_prep(
  data = example_data,
  stat_column = "statistic.site",
  seq_window_col = "SequenceWindow",
  contrast_col = "contrast"
)

dpa_prep_info <- tibble(
  Contrast = names(prep_dpa$ranks),
  Sites = map_int(prep_dpa$ranks, length)
)
knitr::kable(dpa_prep_info, caption = "DPA Contrasts Prepared")
```

### DPA: GSEA without Direction

Standard GSEA ignoring the ;u/;d direction suffixes in PTMsigDB.

```{r dpa_gsea_nodirection}
results_dpa_nodir <- run_ptmsea(
  ranks_list = prep_dpa$ranks,
  pathways = pathways,
  min_size = 3,
  max_size = 500,
  n_perm = 1000,
  pvalueCutoff = 0.1
)

dpa_nodir_info <- tibble(
  Contrast = names(results_dpa_nodir),
  `Significant (FDR < 0.1)` = map_int(results_dpa_nodir, ~nrow(.x@result))
)
knitr::kable(dpa_nodir_info, caption = "DPA GSEA (no direction) Results")
```

```{r dpa_gsea_nodir_plot, fig.width=12, fig.height=8}
merged_dpa_nodir <- merge_result(results_dpa_nodir)
dotplot(merged_dpa_nodir, showCategory = 10,
        title = "DPA GSEA (no direction) - Significant (FDR < 0.1)") +
  ggplot2::theme(axis.text.x = ggplot2::element_text(angle = 45, hjust = 1))
```

### DPA: GSEA with Direction

Splits pathways into _up and _down sets, runs ascending and descending.

```{r dpa_gsea_direction}
results_dpa_dir <- run_ptmsea_up_down(
  ranks_list = prep_dpa$ranks,
  pathways = pathways,
  min_size = 3,
  max_size = 500,
  n_perm = 1000,
  pvalueCutoff = 0.1
)

dpa_dir_info <- tibble(
  Contrast = names(results_dpa_dir),
  `Significant (FDR < 0.1)` = map_int(results_dpa_dir, ~nrow(.x@result))
)
knitr::kable(dpa_dir_info, caption = "DPA GSEA (with direction) Results")
```

```{r dpa_gsea_dir_plot, fig.width=14, fig.height=10}
merged_dpa_dir <- merge_result(results_dpa_dir)
dotplot(merged_dpa_dir, showCategory = 10,
        title = "DPA GSEA (with direction) - Significant (FDR < 0.1)") +
  ggplot2::theme(axis.text.x = ggplot2::element_text(angle = 45, hjust = 1))
```

## DPU Analysis (Differential PTM Usage)

DPU uses protein-normalized phosphosite fold changes, representing true stoichiometry changes independent of protein abundance.

### Prepare DPU Data

```{r prep_dpu}
# Use t-statistic for DPU ranking
prep_dpu <- ptmsea_data_prep(
  data = example_data,
  stat_column = "tstatistic_I",
  seq_window_col = "SequenceWindow",
  contrast_col = "contrast"
)

dpu_prep_info <- tibble(
  Contrast = names(prep_dpu$ranks),
  Sites = map_int(prep_dpu$ranks, length)
)
knitr::kable(dpu_prep_info, caption = "DPU Contrasts Prepared")
```

### DPU: GSEA without Direction

```{r dpu_gsea_nodirection}
results_dpu_nodir <- run_ptmsea(
  ranks_list = prep_dpu$ranks,
  pathways = pathways,
  min_size = 3,
  max_size = 500,
  n_perm = 1000,
  pvalueCutoff = 0.1
)

dpu_nodir_info <- tibble(
  Contrast = names(results_dpu_nodir),
  `Significant (FDR < 0.1)` = map_int(results_dpu_nodir, ~nrow(.x@result))
)
knitr::kable(dpu_nodir_info, caption = "DPU GSEA (no direction) Results")
```

```{r dpu_gsea_nodir_plot, fig.width=12, fig.height=8}
merged_dpu_nodir <- merge_result(results_dpu_nodir)
dotplot(merged_dpu_nodir, showCategory = 10,
        title = "DPU GSEA (no direction) - Significant (FDR < 0.1)") +
  ggplot2::theme(axis.text.x = ggplot2::element_text(angle = 45, hjust = 1))
```

### DPU: GSEA with Direction

```{r dpu_gsea_direction}
results_dpu_dir <- run_ptmsea_up_down(
  ranks_list = prep_dpu$ranks,
  pathways = pathways,
  min_size = 3,
  max_size = 500,
  n_perm = 1000,
  pvalueCutoff = 0.1
)

dpu_dir_info <- tibble(
  Contrast = names(results_dpu_dir),
  `Significant (FDR < 0.1)` = map_int(results_dpu_dir, ~nrow(.x@result))
)
knitr::kable(dpu_dir_info, caption = "DPU GSEA (with direction) Results")
```

```{r dpu_gsea_dir_plot, fig.width=14, fig.height=10}
merged_dpu_dir <- merge_result(results_dpu_dir)
dotplot(merged_dpu_dir, showCategory = 10,
        title = "DPU GSEA (with direction) - Significant (FDR < 0.1)") +
  ggplot2::theme(axis.text.x = ggplot2::element_text(angle = 45, hjust = 1))
```

### DPU: ORA with Direction

Over-representation analysis on significant sites for all contrasts. When `fc_col` is provided, sites are split into up-regulated and down-regulated sets for separate ORA tests.

```{r dpu_ora}
# Convert pathways to TERM2GENE format and strip direction suffixes
term2gene <- ptmsigdb_to_term2gene(pathways) |>
  mutate(gene = gsub(";[ud]$", "", gene))

# Get all PTMsigDB site IDs (stripped, without ;u/;d)
ptmsigdb_sites <- unique(term2gene$gene)

# Run ORA for each contrast (up and down separately)
contrasts <- unique(example_data$contrast)

ora_prep_list <- contrasts |>
  set_names() |>
  map(function(contrast_name) {
    contrast_data <- example_data |>
      filter(contrast == contrast_name)

    prep_ora <- ptmsea_ora_prep(
      data = contrast_data,
      ptmsigdb_sites = ptmsigdb_sites,
      score_col = "FDR_I",
      fc_col = "diff_diff",
      threshold = 0.1
    )

    tibble(
      Contrast = contrast_name,
      Up = length(prep_ora$enriched_up),
      Down = length(prep_ora$enriched_down),
      Background = length(prep_ora$background)
    )
  }) |>
  bind_rows()

ora_results <- contrasts |>
  map(function(contrast_name) {
    contrast_data <- example_data |>
      filter(contrast == contrast_name)

    prep_ora <- ptmsea_ora_prep(
      data = contrast_data,
      ptmsigdb_sites = ptmsigdb_sites,
      score_col = "FDR_I",
      fc_col = "diff_diff",
      threshold = 0.1
    )

    results <- list()

    # ORA for up-regulated sites
    if (length(prep_ora$enriched_up) > 0) {
      ora_up <- enricher(
        gene = prep_ora$enriched_up,
        universe = prep_ora$background,
        TERM2GENE = term2gene,
        pvalueCutoff = 0.1
      )
      if (!is.null(ora_up) && nrow(ora_up@result) > 0) {
        results[[paste0(contrast_name, "_up")]] <- ora_up
      }
    }

    # ORA for down-regulated sites
    if (length(prep_ora$enriched_down) > 0) {
      ora_down <- enricher(
        gene = prep_ora$enriched_down,
        universe = prep_ora$background,
        TERM2GENE = term2gene,
        pvalueCutoff = 0.1
      )
      if (!is.null(ora_down) && nrow(ora_down@result) > 0) {
        results[[paste0(contrast_name, "_down")]] <- ora_down
      }
    }

    results
  }) |>
  list_flatten()

knitr::kable(ora_prep_list, caption = "ORA Preparation Summary")
```

```{r dpu_ora_plot, fig.width=14, fig.height=10}
if (length(ora_results) > 0) {
  merged_ora <- merge_result(ora_results)
  if (nrow(merged_ora@compareClusterResult) > 0) {
    print(dotplot(merged_ora, showCategory = 10,
            title = "DPU ORA (up/down separate) - Significant (FDR < 0.1)") +
      ggplot2::theme(axis.text.x = ggplot2::element_text(angle = 45, hjust = 1)))
  }
}
```

## Interpretation

- **DPA results** show kinase activity changes including protein abundance effects
- **DPU results** show kinase activity changes independent of protein abundance

Kinases appearing significant in **DPU but not DPA** represent genuine signaling changes.
Kinases appearing in **DPA but not DPU** may be driven by protein abundance changes.

## Session Info

```{r session_info}
sessionInfo()
```
