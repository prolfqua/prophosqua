---
title: "PTM-SEA: Kinase Activity Inference from Phosphoproteomics Data"
output:
  bookdown::html_document2:
    code_folding: hide
    toc: true
    toc_float: true
vignette: >
  %\VignetteIndexEntry{PTM-SEA: Kinase Activity Inference from Phosphoproteomics Data}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  warning = FALSE
)
```

## Introduction

PTM-SEA (Post-Translational Modification Signature Enrichment Analysis) uses curated phosphosite signatures from PTMsigDB to infer kinase activities from phosphoproteomics data. This vignette demonstrates GSEA analysis ignoring the ;u/;d suffixes in PTMsigDB.

We analyze both DPA (Differential PTM Abundance) and DPU (Differential PTM Usage) results:

- **DPA results** show kinase activity changes including protein abundance effects
- **DPU results** show kinase activity changes independent of protein abundance

Comparing the two analyses helps identify whether observed kinase activity changes are driven by genuine signaling changes (DPU) or protein abundance effects (DPA only).

## Load Data and PTMsigDB

```{r load_data}
library(prophosqua)
library(clusterProfiler)
library(dplyr)
library(enrichplot)
library(fgsea)
library(purrr)

# Load example data
data("combined_test_diff_example", package = "prophosqua")
example_data <- combined_test_diff_example

data_info <- tibble(
  Property = c("Rows", "Columns", "Contrasts"),
  Value = c(nrow(example_data), ncol(example_data),
            paste(unique(example_data$contrast), collapse = ", "))
)
knitr::kable(data_info, caption = "Example Data")
```

```{r download_ptmsigdb}
# Download PTMsigDB signatures
gmt_path <- download_ptmsigdb(species = "mouse", output_dir = tempdir())
pathways_raw <- fgsea::gmtPathways(gmt_path)

# Trim pathways to 11-mer (default) to increase overlap with our data
pathways <- trim_ptmsigdb_pathways(pathways_raw, trim_to = "11")
```

## Overlap Statistics

Understanding the overlap between our data and PTMsigDB is crucial for interpreting results.

```{r overlap_stats}
# Our data: unique flanking sequences (trimmed to 11-mer to match pathways)
our_sequences <- example_data |>
  pull(SequenceWindow) |>
  trimws() |>
  toupper() |>
  unique()
our_sequences_trimmed <- our_sequences |>
  map_chr(~prophosqua:::trim_flanking_seq(.x, trim_to = 11L))
our_site_ids <- paste0(our_sequences_trimmed, "-p")
n_our_sites <- n_distinct(our_site_ids)

# PTMsigDB: unique site IDs (strip ;u/;d for comparison)
ptmsigdb_ids_raw <- pathways |>
  unlist() |>
  unique()
ptmsigdb_ids_stripped <- ptmsigdb_ids_raw |>
  gsub(";[ud]$", "", x = _) |>
  unique()
n_ptmsigdb_sites <- length(ptmsigdb_ids_stripped)

# Overlap
overlap_ids <- intersect(unique(our_site_ids), ptmsigdb_ids_stripped)
n_overlap <- length(overlap_ids)

overlap_stats <- tibble(
  Metric = c("Our data (unique sequences)", "PTMsigDB (unique site IDs)", "Overlap",
             "% of our sites", "% of PTMsigDB sites"),
  Value = c(n_our_sites, n_ptmsigdb_sites, n_overlap,
            round(100 * n_overlap / n_our_sites, 2),
            round(100 * n_overlap / n_ptmsigdb_sites, 2))
)
knitr::kable(overlap_stats, caption = "Overlap Statistics (11-mer)")
```

The low overlap is expected because:

1. PTMsigDB contains curated kinase-substrate relationships (~1,700 unique sites)
2. Our phosphoproteomics data measures ~20,000+ sites
3. Most measured sites have no known kinase annotation

## DPA Analysis (Differential PTM Abundance)

DPA uses raw phosphosite fold changes, which include both true signaling changes and protein abundance effects.

### Prepare DPA Data

```{r prep_dpa}
# Use t-statistic for ranking
prep_dpa <- ptmsea_data_prep(
  data = example_data,
  stat_column = "statistic.site",
  seq_window_col = "SequenceWindow",
  contrast_col = "contrast"
)

dpa_prep_info <- tibble(
  Contrast = names(prep_dpa$ranks),
  Sites = map_int(prep_dpa$ranks, length)
)
knitr::kable(dpa_prep_info, caption = "DPA Contrasts Prepared")
```

### DPA: GSEA without Direction

Standard GSEA ignoring the ;u/;d direction suffixes in PTMsigDB.

```{r dpa_gsea_nodirection}
results_dpa_nodir <- run_ptmsea(
  ranks_list = prep_dpa$ranks,
  pathways = pathways,
  min_size = 3,
  max_size = 500,
  n_perm = 1000,
  pvalueCutoff = 0.1
)

dpa_nodir_info <- tibble(
  Contrast = names(results_dpa_nodir),
  `Significant (FDR < 0.1)` = map_int(results_dpa_nodir, ~nrow(.x@result))
)
knitr::kable(dpa_nodir_info, caption = "DPA GSEA (no direction) Results")
```

```{r dpa_gsea_nodir_plot, fig.width=14, fig.height=10}
merged_dpa_nodir <- merge_result(results_dpa_nodir)
dotplot(merged_dpa_nodir, showCategory = 15,
        title = "DPA GSEA - PTM-SEA (FDR < 0.1)") +
  ggplot2::theme(axis.text.x = ggplot2::element_text(angle = 45, hjust = 1))
```

```{r dpa_gsea_individual, fig.width=14, fig.height=10}
dpa_plots <- names(results_dpa_nodir) |>
  map(function(ct) {
    res <- results_dpa_nodir[[ct]]
    if (nrow(res@result) > 0) {
      dotplot(res, showCategory = 15, title = ct) +
        ggplot2::theme(axis.text.y = ggplot2::element_text(size = 8))
    } else {
      ggplot2::ggplot() +
        ggplot2::annotate("text", x = 0.5, y = 0.5, label = paste("No results for", ct)) +
        ggplot2::theme_void() +
        ggplot2::ggtitle(ct)
    }
  })
patchwork::wrap_plots(dpa_plots, ncol = 2)
```

## DPU Analysis (Differential PTM Usage)

DPU uses protein-normalized phosphosite fold changes, representing true stoichiometry changes independent of protein abundance.

### Prepare DPU Data

```{r prep_dpu}
# Use t-statistic for DPU ranking
prep_dpu <- ptmsea_data_prep(
  data = example_data,
  stat_column = "tstatistic_I",
  seq_window_col = "SequenceWindow",
  contrast_col = "contrast"
)

dpu_prep_info <- tibble(
  Contrast = names(prep_dpu$ranks),
  Sites = map_int(prep_dpu$ranks, length)
)
knitr::kable(dpu_prep_info, caption = "DPU Contrasts Prepared")
```

### DPU: GSEA without Direction

```{r dpu_gsea_nodirection}
results_dpu_nodir <- run_ptmsea(
  ranks_list = prep_dpu$ranks,
  pathways = pathways,
  min_size = 3,
  max_size = 500,
  n_perm = 1000,
  pvalueCutoff = 0.1
)

dpu_nodir_info <- tibble(
  Contrast = names(results_dpu_nodir),
  `Significant (FDR < 0.1)` = map_int(results_dpu_nodir, ~nrow(.x@result))
)
knitr::kable(dpu_nodir_info, caption = "DPU GSEA (no direction) Results")
```

```{r dpu_gsea_nodir_plot, fig.width=14, fig.height=10}
merged_dpu_nodir <- merge_result(results_dpu_nodir)
dotplot(merged_dpu_nodir, showCategory = 15,
        title = "DPU GSEA - PTM-SEA (FDR < 0.1)") +
  ggplot2::theme(axis.text.x = ggplot2::element_text(angle = 45, hjust = 1))
```

```{r dpu_gsea_individual, fig.width=14, fig.height=10}
dpu_plots <- names(results_dpu_nodir) |>
  map(function(ct) {
    res <- results_dpu_nodir[[ct]]
    if (nrow(res@result) > 0) {
      dotplot(res, showCategory = 15, title = ct) +
        ggplot2::theme(axis.text.y = ggplot2::element_text(size = 8))
    } else {
      ggplot2::ggplot() +
        ggplot2::annotate("text", x = 0.5, y = 0.5, label = paste("No results for", ct)) +
        ggplot2::theme_void() +
        ggplot2::ggtitle(ct)
    }
  })
patchwork::wrap_plots(dpu_plots, ncol = 2)
```

## Diagnostics

```{r diagnostic_pvalues}
pval_diag <- names(results_dpa_nodir) |>
  map_dfr(function(ct) {
    res <- results_dpa_nodir[[ct]]@result
    tibble(
      Contrast = ct,
      `Min p-value` = signif(min(res$pvalue), 3),
      `p < 0.05` = sum(res$pvalue < 0.05),
      `p < 0.01` = sum(res$pvalue < 0.01),
      Total = nrow(res)
    )
  })
knitr::kable(pval_diag, caption = "Raw p-value Distribution (DPA)")
```

```{r show_top_pathways}
if (length(results_dpa_nodir) > 0) {
  top_res <- results_dpa_nodir[[1]]@result |>
    as_tibble() |>
    arrange(pvalue) |>
    head(10) |>
    select(ID, enrichmentScore, NES, pvalue, p.adjust, setSize) |>
    mutate(
      enrichmentScore = round(enrichmentScore, 3),
      NES = round(NES, 3),
      pvalue = signif(pvalue, 3),
      p.adjust = signif(p.adjust, 3)
    )
  knitr::kable(top_res,
    caption = paste("Top 10 Pathways by P-value (DPA,",
                    names(results_dpa_nodir)[1], ")"))
}
```

### GSEA Enrichment Plot (Example)

```{r gsea_plots_dpa, fig.width=10, fig.height=6}
# Show single example for illustration
ct <- names(results_dpa_nodir)[1]
res <- results_dpa_nodir[[ct]]

if (nrow(res@result) > 0) {
  top_pathway <- res@result |>
    as_tibble() |>
    arrange(pvalue) |>
    slice(1) |>
    pull(ID)

  row <- res@result |>
    as_tibble() |>
    filter(ID == top_pathway)
  nes_val <- round(row$NES, 2)
  fdr <- signif(row$p.adjust, 2)

  gseaplot2(res, geneSetID = top_pathway,
    title = paste0(ct, " - ", top_pathway, " (NES=", nes_val, ", FDR=", fdr, ")"))
}
```

## Session Info

```{r session_info}
sessionInfo()
```
