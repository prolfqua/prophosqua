---
title: "Visualizing Kinase Library MEA Results"
output:
  bookdown::html_document2:
    code_folding: hide
    toc: true
    toc_float: true
vignette: >
  %\VignetteIndexEntry{Visualizing Kinase Library MEA Results}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  warning = FALSE
)
```

## Introduction

This vignette demonstrates how to visualize Motif Enrichment Analysis (MEA) results from the Kinase Library CLI tools. We'll create dotplots for individual contrasts and combined views across all contrasts.

## Load Libraries and Data

```{r load_libraries}
library(dplyr)
library(forcats)
library(ggplot2)
library(purrr)
library(tidyr)
```

```{r load_data}
# Load all MEA results
data_dir <- here::here("vignettes")
mea_files <- list.files(data_dir, pattern = "^mea_.*\\.csv$", full.names = TRUE)

# Read and combine all MEA results
mea_results <- mea_files |>
  map_dfr(function(f) {
    contrast_name <- gsub("^mea_|\\.csv$", "", basename(f))
    read.csv(f) |>
      mutate(contrast = contrast_name)
  })

load_info <- tibble(
  Metric = c("MEA result files", "Total rows", "Contrasts"),
  Value = c(length(mea_files), nrow(mea_results),
            paste(unique(mea_results$contrast), collapse = ", "))
)
knitr::kable(load_info, caption = "Data Loaded")
```

```{r preview_data}
# Preview the data structure
mea_results |>
  select(Kinase, ES, NES, `p.value`, FDR, contrast) |>
  head()
```

## Data Preparation

```{r prep_data}
# Clean up and prepare data for plotting
mea_clean <- mea_results |>
  rename(
    kinase = Kinase,
    pvalue = `p.value`
  ) |>
  mutate(
    neg_log10_fdr = -log10(FDR + 1e-10),
    neg_log10_pval = -log10(pvalue + 1e-10),
    significant = FDR < 0.1,
    direction = case_when(
      NES > 0 ~ "Up",
      NES < 0 ~ "Down",
      TRUE ~ "None"
    )
  )

# Summary of significant results
sig_summary <- mea_clean |>
  filter(significant) |>
  group_by(contrast, direction) |>
  summarise(n = n(), .groups = "drop") |>
  pivot_wider(names_from = direction, values_from = n, values_fill = 0)
knitr::kable(sig_summary, caption = "Significant Results (FDR < 0.1)")
```

## Individual Contrast Dotplots

```{r dotplot_function}
# Function to create dotplot for a single contrast
plot_mea_dotplot <- function(data, contrast_name, top_n = 20, fdr_cutoff = 0.25) {
  plot_data <- data |>
    filter(contrast == contrast_name, FDR < fdr_cutoff) |>
    arrange(FDR) |>
    head(top_n) |>
    mutate(kinase = fct_reorder(kinase, -FDR))


  if (nrow(plot_data) == 0) {
    return(ggplot() +
             annotate("text", x = 0.5, y = 0.5,
                      label = paste("No significant results for", contrast_name,
                                    "\n(FDR <", fdr_cutoff, ")")) +
             theme_void())
  }

  ggplot(plot_data, aes(x = NES, y = kinase)) +
    geom_point(aes(size = neg_log10_fdr, color = NES)) +
    scale_color_gradient2(
      low = "blue", mid = "white", high = "red", midpoint = 0,
      name = "NES"
    ) +
    scale_size_continuous(name = "-log10(FDR)", range = c(2, 8)) +
    geom_vline(xintercept = 0, linetype = "dashed", color = "gray50") +
    labs(
      title = paste("MEA Results:", contrast_name),
      subtitle = paste("Top", min(top_n, nrow(plot_data)), "kinases (FDR <", fdr_cutoff, ")"),
      x = "Normalized Enrichment Score (NES)",
      y = "Kinase"
    ) +
    theme_minimal() +
    theme(
      axis.text.y = element_text(size = 9),
      plot.title = element_text(face = "bold"),
      legend.position = "right"
    )
}
```

```{r individual_plots, fig.height=10}
# Generate dotplot for each contrast
contrasts <- unique(mea_clean$contrast)

walk(contrasts, function(ct) {
  p <- plot_mea_dotplot(mea_clean, ct, top_n = 25, fdr_cutoff = 0.25)
  print(p)
})
```

## Combined Heatmap Across All Contrasts

```{r combined_heatmap, fig.width=12, fig.height=10}
# Get top kinases across all contrasts
top_kinases <- mea_clean |>
  filter(FDR < 0.25) |>
  group_by(kinase) |>
  summarise(
    min_fdr = min(FDR),
    mean_abs_nes = mean(abs(NES)),
    n_contrasts = n()
  ) |>
  arrange(min_fdr) |>
  head(30) |>
  pull(kinase)

# Prepare data for heatmap
heatmap_data <- mea_clean |>
  filter(kinase %in% top_kinases) |>
  select(kinase, contrast, NES, FDR) |>
  mutate(
    kinase = factor(kinase, levels = rev(top_kinases)),
    significance = case_when(
      FDR < 0.05 ~ "***",
      FDR < 0.1 ~ "**",
      FDR < 0.25 ~ "*",
      TRUE ~ ""
    )
  )

# Create heatmap
ggplot(heatmap_data, aes(x = contrast, y = kinase, fill = NES)) +
  geom_tile(color = "white", linewidth = 0.5) +
  geom_text(aes(label = significance), color = "black", size = 3) +
  scale_fill_gradient2(
    low = "blue", mid = "white", high = "red", midpoint = 0,
    name = "NES",
    limits = c(-max(abs(heatmap_data$NES)), max(abs(heatmap_data$NES)))
  ) +
  labs(
    title = "Kinase Activity Across Contrasts",
    subtitle = "Top 30 kinases by FDR (* p<0.25, ** p<0.1, *** p<0.05)",
    x = "Contrast",
    y = "Kinase"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, size = 10),
    axis.text.y = element_text(size = 9),
    plot.title = element_text(face = "bold"),
    panel.grid = element_blank()
  )
```

## Combined Dotplot (Faceted)

```{r faceted_dotplot, fig.width=14, fig.height=10}
# Top kinases for faceted plot
plot_data_facet <- mea_clean |>
  filter(kinase %in% top_kinases) |>
  mutate(kinase = factor(kinase, levels = rev(top_kinases)))

ggplot(plot_data_facet, aes(x = NES, y = kinase)) +
  geom_point(aes(size = neg_log10_fdr, color = NES, alpha = significant)) +
  scale_color_gradient2(
    low = "blue", mid = "white", high = "red", midpoint = 0,
    name = "NES"
  ) +
  scale_size_continuous(name = "-log10(FDR)", range = c(1, 6)) +
  scale_alpha_manual(values = c("TRUE" = 1, "FALSE" = 0.3), guide = "none") +
  geom_vline(xintercept = 0, linetype = "dashed", color = "gray50") +
  facet_wrap(~contrast, ncol = 2) +
  labs(
    title = "MEA Results Across All Contrasts",
    subtitle = "Top 30 kinases by minimum FDR (transparent = FDR >= 0.1)",
    x = "Normalized Enrichment Score (NES)",
    y = "Kinase"
  ) +
  theme_minimal() +
  theme(
    axis.text.y = element_text(size = 7),
    strip.text = element_text(face = "bold", size = 10),
    plot.title = element_text(face = "bold"),
    legend.position = "right"
  )
```

## Volcano-style Plot

```{r volcano_plot, fig.width=12, fig.height=8}
# Volcano plot for each contrast
ggplot(mea_clean, aes(x = NES, y = neg_log10_fdr)) +

geom_point(aes(color = significant), alpha = 0.6, size = 2) +
  geom_hline(yintercept = -log10(0.1), linetype = "dashed", color = "red") +
  geom_text(
    data = mea_clean |>
      filter(FDR < 0.05) |>
      group_by(contrast) |>
      slice_min(FDR, n = 5),
    aes(label = kinase),
    size = 2.5,
    hjust = -0.1,
    check_overlap = TRUE
  ) +
  scale_color_manual(
    values = c("TRUE" = "red", "FALSE" = "gray50"),
    name = "FDR < 0.1"
  ) +
  facet_wrap(~contrast, scales = "free") +
  labs(
    title = "MEA Volcano Plots",
    subtitle = "Dashed line: FDR = 0.1; Labels: top 5 by FDR per contrast",
    x = "Normalized Enrichment Score (NES)",
    y = "-log10(FDR)"
  ) +
  theme_minimal() +
  theme(
    strip.text = element_text(face = "bold"),
    plot.title = element_text(face = "bold")
  )
```

## Summary Table

```{r summary_table}
# Summary of significant kinases
summary_table <- mea_clean |>
  filter(FDR < 0.1) |>
  select(contrast, kinase, NES, FDR) |>
  arrange(contrast, FDR) |>
  mutate(
    NES = round(NES, 3),
    FDR = signif(FDR, 3)
  )

if (nrow(summary_table) > 0) {
  knitr::kable(
    summary_table,
    caption = "Significant Kinases (FDR < 0.1)",
    col.names = c("Contrast", "Kinase", "NES", "FDR")
  )
}
```

## Session Info

```{r session_info}
sessionInfo()
```
